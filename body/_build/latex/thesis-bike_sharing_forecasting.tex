%% Generated by Sphinx.
\def\sphinxdocclass{jupyterBook}
\documentclass[letterpaper,10pt,english]{jupyterBook}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax
\ifdefined\pdfimageresolution
    \pdfimageresolution= \numexpr \dimexpr1in\relax/\sphinxpxdimen\relax
\fi
%% let collapsible pdf bookmarks panel have high depth per default
\PassOptionsToPackage{bookmarksdepth=5}{hyperref}
%% turn off hyperref patch of \index as sphinx.xdy xindy module takes care of
%% suitable \hyperpage mark-up, working around hyperref-xindy incompatibility
\PassOptionsToPackage{hyperindex=false}{hyperref}
%% memoir class requires extra handling
\makeatletter\@ifclassloaded{memoir}
{\ifdefined\memhyperindexfalse\memhyperindexfalse\fi}{}\makeatother

\PassOptionsToPackage{warn}{textcomp}

\catcode`^^^^00a0\active\protected\def^^^^00a0{\leavevmode\nobreak\ }
\usepackage{cmap}
\usepackage{fontspec}
\defaultfontfeatures[\rmfamily,\sffamily,\ttfamily]{}
\usepackage{amsmath,amssymb,amstext}
\usepackage{polyglossia}
\setmainlanguage{english}



\setmainfont{FreeSerif}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Italic,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldItalic
]
\setsansfont{FreeSans}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Oblique,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldOblique,
]
\setmonofont{FreeMono}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Oblique,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldOblique,
]



\usepackage[Bjarne]{fncychap}
\usepackage[,numfigreset=1,mathnumfig]{sphinx}

\fvset{fontsize=\small}
\usepackage{geometry}


% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}


\usepackage{sphinxmessages}



        % Start of preamble defined in sphinx-jupyterbook-latex %
         \usepackage[Latin,Greek]{ucharclasses}
        \usepackage{unicode-math}
        % fixing title of the toc
        \addto\captionsenglish{\renewcommand{\contentsname}{Contents}}
        \hypersetup{
            pdfencoding=auto,
            psdextra
        }
        % End of preamble defined in sphinx-jupyterbook-latex %
        

\title{A Comparison of Forecasting Techniques in Bike Sharing Services}
\date{Nov 12, 2021}
\release{}
\author{Luca Baggi}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{}
\makeindex
\begin{document}

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{frontmatter::doc}}


\sphinxAtStartPar
Insert catchphrase


\chapter{Introduction}
\label{\detokenize{01-introduction:introduction}}\label{\detokenize{01-introduction::doc}}

\section{COVID\sphinxhyphen{}19 Effects and Mobility Habits in Italy}
\label{\detokenize{01-introduction:covid-19-effects-and-mobility-habits-in-italy}}
\sphinxAtStartPar
The COVID\sphinxhyphen{}19 pandemic set the world back in its pursuit of the seventeen Sustainable Development Goals (SDGs) (The 17 Goals, n.d.). This is also the case for Italy, as we can see from the 92 statistical measures collected by the Italian national institute for statistics (ISTAT, Istituto Nazionale di Statistica). When comparing 2019 with data from ten years prior, sixty percent of the measurements register an improvement, while twenty percent do not change and the remainder worsens. However, when comparing 2019 and 2020, only forty percent of the measurements improve, and almost the same amount displays a statistically significant drop (Dall’andamento degli obiettivi di sviluppo sostenibile alla mobilità, 2021).

\sphinxAtStartPar
To say that the pandemic brought about a lot of change would be a redundant understatement. Coming out of 2020, the Italian outlook is worse than the average of the (Western) European countries \sphinxhyphen{} as one can notice upon looking at macroeconomic variables such as the Gross Domestic Product (GDP). Part of the negative consequences could be offset, thanks to the government’s stimulus packages, the European Union’s (EU) funds and the European Central Bank’s (ECB) Pandemic Emergency Purchase Program, or PEPP \sphinxhyphen{} a massive asset purchase program of 1,850 billion euros. From the beginning, it was clear that the pandemic would accelerate digitalisation (Härmand, 2021) \sphinxhyphen{} and, indeed, it has: see (Anthony Jnr \& Abbas Petersen, 2021) for a meta\sphinxhyphen{}review or (Truant et al., 2021) for Italy. The generalised lockdowns reduced the greenhouse gases (GHG) emissions (see (Jephcote et al., 2021), (Singh \& Chauhan, 2020), (Lian et al., 2020) and (Gualtieri et al., 2020)) but only temporarily and relatively to the severity of the restrictions put in place: the pandemic altered electricity consumption habits, but in countries like Sweden “the consumption even increased” compared to 2019 (Bahmanyar et al., 2020). Besides, this also came at the expense of our transportation habits and the mobility sector in general.

\sphinxAtStartPar
According to ISTAT, private cars are now used for half of all travels, up from 44 percent in the pre\sphinxhyphen{}pandemic period. Furthermore, the so\sphinxhyphen{}called “mobilità dolce” (the Italian translation of micro\sphinxhyphen{}mobility) “does not seem to take off” (Dall’andamento degli obiettivi di sviluppo sostenibile alla mobilità, 2021). In 2020, 30 percent of interviewed families stated that they had “some or a lot of difficulties in connecting with public transportation in the area where they live” \sphinxhyphen{} an improvement from the 33 percent of the previous year. However, it is enough to look at the regional level to realise that improvements are not spread evenly, and some areas of the country are actually worse off with respect to 2019. There is a great deal of heterogeneity: the share of families with troubles in accessing public transportation services is lower in the North (26 percent) compared to the South (36 percent), while in Campania more than half of the families are affected (51 percent). Furthermore, only 27 percent of students reach the places where they study with public means of transportation (and it’s declining), while 75 percent reach the workplace with private means only (and the share is increasing) (Dall’andamento degli obiettivi di sviluppo sostenibile alla mobilità, 2021).

\sphinxAtStartPar
The only measurement that has been improving throughout the decade is that of air quality. However, these values remain significantly higher than the guidelines from the World Health Organisation (WHO) (Dall’andamento degli obiettivi di sviluppo sostenibile alla mobilità, 2021). Besides, on September 22, 2021 the WHO revised downwards their recommendations on air pollutants (the latest update dated back to 2005), and the European Commission (EC) declared that it will take this update into account when revising the guidelines for the upcoming year (Standards \sphinxhyphen{} Air Quality \sphinxhyphen{} Environment \sphinxhyphen{} European Commission, n.d.). Italy has always struggled to respect the European Directive on air pollution: on November 2020, the European Court of Justice (ECJ) judged that, from 2008 to 2017, Italy “systematically and continuously” violated the standards set by the Directive and failed in enacting countermeasures to avoid it (“Che Aria Respiriamo,” 2021). On July 2021, the European Environmental Agency (EEA) ranked European cities according to the average level of \(PM_{2.5}\) in the two previous years: out of 323 cities, Cremona (Lombardy) was second to last, Brescia and Pavia (both in Lombardy) were 315th and 314th respectively, while Venezia (Veneto) was 311st, Bergamo 306th and Milano 303rd (all in Lombardy) (European City Air Quality Viewer — European Environment Agency, 2021). Air pollution caused more than \sphinxstyleemphasis{52 thousands} premature deaths: almost 14 percent of the total premature death toll in Europe (Italy \sphinxhyphen{} Air Pollution Country Fact Sheet — European Environment Agency, 2020).

\sphinxAtStartPar
Unequal access to infrastructure (and, to a minor degree, air pollution) hinder the popularity of more sustainable mode of transport, such as biking and sharing services. The ISTAT report mentioned above estimated that in 2019 there were 30 million commuters in Italy (Gli spostamenti per motivi di studio o lavoro nel 2019 secondo il Censimento permanente della popolazione, 2021): more than two thirds (more than 20 million) need to reach their workplace, while the rest is made up of students (with a moderate variance: the share of students is higher in those regions where unemployment is higher, for example in Campania, where they make up 40\% of commuters). However, the report did not present any data on biking habits or the use of sharing services. These can only be found in an earlier report, published in 2019 and referring to two years prior.

\sphinxAtStartPar
The 2019 report mentions two interesting statistics about commuting habits: “almost one in five {[}commuters{]} choose an ‘active’ mode of transport” \sphinxhyphen{} that is, walking or biking. However, most of the “active” commuters are actually walking to work (17,4\%), whereas the bikers are only some 1,7\%. In general, it is women, young and more educated people who use more public transportation means and bicycles, while private vehicles (the exclusive means of commuting for more than 73 percent of the employed) are spread among men between 25 to 44 and with an average level of education (Spostamenti quotidiani e nuove forme di mobilità, 2019). Car pooling is chosen by some 12 percent of the employed and 14,5 percent of students aged 18\sphinxhyphen{}24, while only less than half a million used bike sharing services at least once during the year (i.e., less than 2 percent). Such services are more popular across the young and more educated people, while the incidence is almost double the national average in metropolitan cities (Spostamenti quotidiani e nuove forme di mobilità, 2019).


\section{Bike\sphinxhyphen{}Sharing Demand Determinants and the State of Public Transport Infrastructure in Italy}
\label{\detokenize{01-introduction:bike-sharing-demand-determinants-and-the-state-of-public-transport-infrastructure-in-italy}}
\sphinxAtStartPar
The picture drawn by the two ISTAT reports feels like a pool of untapped (if not wasted) potential. According to the most recent survey, in 2019 some 57,5\% percent of commuters moved within the same municipality of residence. This value is driven up by the students, who make up almost 71 percent of commuters within the same municipality. However, even after taking them out of the computation, we still end up with an even figure: more than 51 percent of workers move within the same municipality (Gli spostamenti per motivi di studio o lavoro nel 2019 secondo il Censimento permanente della popolazione, 2021).

\sphinxAtStartPar
Sure, it would be naive to argue that commuters who work in the same municipality where they live could all bike to reach their destinations: after all, there is a great deal of heterogeneity across municipalities under several dimensions \sphinxhyphen{} like their sheer extension, morphology and, of course, infrastructure. There are many factors that affect bike sharing demand: the first one that comes to mind are the weather conditions: precipitations, humidity and seasonal patterns; the one that arguably plays the biggest role is the so\sphinxhyphen{}called “built environment” (Eren \& Uz, 2020), i.e. infrastructure such as the availability of isolated or dedicated bike lanes instead of mixed ones, but also safe parking areas and bike racks for private bikes. The terrain clearly plays a role: slopes have a negative effect on bike usage (as one of the many examples, see (Bordagaray et al., 2016)), but incentive schemes can be devised to promote returning bikes to up\sphinxhyphen{}hill stations and even the least loaded ones (which also improves the overall efficiency of the system) (Fricker \& Gast, 2016). Furthermore, in this scenario there is a positive effect of e\sphinxhyphen{}bikes. Besides, the literature also outlines the role of land use: pick\sphinxhyphen{}ups are more frequent in commercial areas and parks, compared to residential ones and, more broadly “the proximity to green spaces and recreation areas, schools, universities, museums, shopping centers, sports areas, restaurants, hotels, bus/subway/train/suburban/ ferry transit hubs has a positive effect on the use of BSP {[}Bike Sharing Programs{]}” (Eren \& Uz, 2020).

\sphinxAtStartPar
The degree of integration with the public transportation is also important, as bike\sphinxhyphen{}sharing systems are found to be complementary means for “{[}bridging{]} the gap between multiple transit hubs” (Eren \& Uz, 2020). But bike sharing can also be a substitute “especially when public transport is not available, between 22:00 pm {[}and{]} 06:00 a.m., they can encourage users to use BSP” (Eren \& Uz, 2020). This implies that there is no single channel to promote bike\sphinxhyphen{}sharing services and that coordination across institutional players is crucial. Despite this, investments in bike\sphinxhyphen{}sharing services shall not fall in the background: their complementary role as “first/last mile solution” is recognised in the literature and enhance public transport as a whole.

\sphinxAtStartPar
Improving the public transport infrastructure is a priority for Italy. As always, there are territorial imbalances on two different dimensions: on the macro level, there is a clear divide between North and South, but there continue to be striking differences even within the wealthiest regions. Bike lanes have been increasing steadily: the total number of kilometres has grown by 15,5 percent since 2015, totalling approximately 4700 kilometres. However, the infrastructure is still far from adequate in most cities (Ambiente urbano, 2021).

\sphinxAtStartPar
The report from ISTAT outlines that public transport (or TPL, “trasporto pubblico locale”) suffers both from lack of infrastructure and outdated fleets. As a starter, the TPL is over reliant on buses, which offer more than 55 percent of the number of seats per kilometre. However, once metropolitan cities are factored out, this figure skyrockets to well beyond 90\sphinxhyphen{}95 percent (Ambiente urbano, 2021). Only 32 percent of the bus fleets is in line with Euro 6 standard and some 34 percent belongs to the Euro 4 class \sphinxhyphen{} i.e., was deployed before 2008. Low emission buses make up some 28 percent of the total, but only slightly more than 3 percent are electric: the rest (almost 25 percent) is fuelled by natural gas. Unsurprisingly, the share of low\sphinxhyphen{}emission vehicles is higher in metropolitan cities.

\sphinxAtStartPar
Trolley buses are available in only 13 municipalities, trams in 11 and metropolitan trains in 7. However, there is a remarkable divide between the Italian champion, Milan, and the other cities. Tram network density in Milan is measured as 122 km per 100 squared kilometres; the silver medal is awarded to Turin, which has almost half the kilometres than Milan: 66. The average of the other cities is a mere 16 km. In general, while the supply of TPL (measured in seats per kilometre, per inhabitant) is on the rise, we are still far from the levels before the Great Recession (\sphinxhyphen{}7,3 percent compared to 2008). However, the supply in the North is 25 percent greater compared to the Centre and almost three times bigger than the South. Public demand for TPL is increasing in the North, stationary in the Centre and even declining in the South.

\sphinxAtStartPar
A minor and uneven push is provided by sharing services. Car sharing is available in 37 out of 107 “comuni capoluogo” (i.e., the “capital” of a province, corresponding to the NUTS3 classification), of which only 8 are in the South. Besides, only 26 percent of the fleets is composed of electric cars. Bike sharing services are present in 53 \sphinxstyleemphasis{capoluoghi}, registering an overall decline from 2015. Luckily, the number of bikes has more than tripled: from 6 to 19 bicycles per ten thousand inhabitants. The divide, as always, is quite stark: the number of bikes is 29 in metropolis compared to provinces, and these services are much more common in the North (32 bikes per ten thousand citizens) than in the Centre (17) and the South (just 2). Much of this success is to be attributed to the appearance of free\sphinxhyphen{}float systems, which require greater fleets (Ambiente urbano, 2021). The report does not provide information on electric scooters.

\sphinxAtStartPar
Restructuring the public transport will require extensive coordination between national, regional and municipal administrations, across multiple channels simultaneously. It is a widespread hope that many of this results can (only) be achieved via the Next Generation EU (NGEU), the 750 billion euros stimulus that will be financed by bonds from the European Commission. The NGEU is a bold and unprecedented move from the EU: the fund will be made up with up to 390 billion euros in subsidies, while up to 360 billions will be given out as loans with low interest rates. Italy is the first beneficiary in absolute terms for the main facilities of the NGEU: the country will receive more than 190 billion euros, to which the government will add 30 billions of its own. According to the so\sphinxhyphen{}called PNRR (\sphinxstyleemphasis{Piano Nazionale di Recupero e Resilienza}, i.e. National Plan of Recovery and Resilience), almost 25 billion euros will be invested in railways. However, less than one billion will be used to improve on the regional railways \sphinxhyphen{} the Achilles’ heel of public transportation and the bane of commuters. In addition, more than 8,5 billion euros will be invested in TPL. But there’s a catch: the NGEU grants will only be available for projects to be completed within the year 2026. Interviewed by \sphinxstyleemphasis{Il Post}, prof. Gabriele Grea from Bocconi University stated that these funds will mostly be awarded to projects in an already “advanced state”: on one side, this will provide stronger guarantees about their completion, but will likely increase the inequalities across municipalities (Un po’ di cose notevoli dentro il PNRR, 2021).


\section{The Case for Promoting Bike Sharing}
\label{\detokenize{01-introduction:the-case-for-promoting-bike-sharing}}
\sphinxAtStartPar
Reforming the public transport will be crucial to reach carbon neutrality and possibly promote economic growth. After all, transport accounts for as much as 27 percent of emissions in the EU (Bergantino et al., 2021) and while the overall greenhouse gases (GHG) emissions has been declining since the 1990s, the emissions from road transportation has nonetheless been increasing ever since (Annual European Union Greenhouse Gas Inventory 1990–2018 and Inventory Report 2020 — European Environment Agency, 2020). Besides, it is well\sphinxhyphen{}known that Italy chose to privilege rubber over railways to transport goods: Eurostat estimated that from 2000 to 2016 less than 10 percent of goods travelled by train, while the EU average was almost 18 percent (Milano ha un’occasione storica, 2017), so there seems to be much room to increase productivity. And, besides, despite the fact that emissions have been decreasing since the 1990s, Italy is not on the side of the achievers: since 1990, emissions in the country were reduced by 17,2 percent, compared to the EU28’s 25,2 percent.

\sphinxAtStartPar
The Next Generation EU provides Italy with the perfect chance to narrow the divide with Western economies, while curbing emissions and finally improving the air quality. To promote more sustainable modes of transport, measures are needed on both the supply side (for example, by improving vehicle and fuel performance) and on the demand side by reducing demand for private transport, or at least increasing the demand for greener modes of transport (Bergantino et al., 2021). Investments in sharing services can and should play a role in this transition. Indeed, capital might be limited: after all, municipalities will receive a smaller share of the NGEU funds and upgrading their bus fleets seems more urgent. Besides, there are also the time constraints that need to be taken into account. However, biking infrastructure projects can be relatively cheaper compared to other TPL investments \sphinxhyphen{} especially if factoring in the presence of private entrepreneurs. Once infrastructure is in place, the costs of the service “only” amount to the human and technical cost to reallocate bikes to be at the right place at the right time.

\sphinxAtStartPar
This dissertation stems from the idea that bike sharing systems can be promoted with cheap measures. One of the most widely discussed problems in the literature is improving customer satisfaction through repositioning, i.e. forecasting the demand for bikes and “design efficient bike repositioning solutions” (Ghosh et al., 2019). The problem is ever more important since the introduction of free\sphinxhyphen{}float bike\sphinxhyphen{}sharing systems (FFBBS), as the bikes can be dropped anywhere and end up in sub\sphinxhyphen{}optimal places for the next customers.
On the positive side, FFBBS do not require the upfront investments for building docking stations \sphinxhyphen{} which is necessary for station\sphinxhyphen{}based BSS (also known as SBSS). Furthermore, FFBSS “prevents bike theft”, “by tracking bikes in real\sphinxhyphen{}time with built\sphinxhyphen{}in GPS”, and “offers significant opportunities for smart management”(Pal \& Zhang, 2017). This implies a greater satisfaction level for customers, “because obtaining and returning the bikes becomes much more convenient” (Pal \& Zhang, 2017). However, all of this comes at the increased costs for bike rebalancing, because of how inefficient bike redistribution becomes and the and higher operating costs in terms of human and financial resources (Pal \& Zhang, 2017). This has been recognised as “one of the main reasons why many FFBS enterprises lose money or even withdrawn from market.”(Tian et al., 2021).

\sphinxAtStartPar
Most of the new approaches involve deep learning (DL) techniques, such as long\sphinxhyphen{}term short\sphinxhyphen{}memory (LSTM) neural networks, which usually outperform other statistical and machine learning approaches (Xu et al., 2018). Some are incredibly sophisticated: Convolutional LSTM are deep learning models “stacked and fused by multiple convolutional long short\sphinxhyphen{}term memory (LSTM) layers, standard LSTM layers, and convolutional layers {[}…{]} to better capture the spatio\sphinxhyphen{}temporal characteristics and correlations of explanatory variables” (Ke et al., 2017). This, combined with external data such as “travel time rate, time\sphinxhyphen{}of\sphinxhyphen{}day, day\sphinxhyphen{}of\sphinxhyphen{}week, and weather conditions”, results in an improvement of error metrics (RMSE) by almost 50 percent (Ke et al., 2017).

\sphinxAtStartPar
There is no way we could best the performance of such sophisticated models. However, this may not be the ultimate goal for policymakers. Despite their impressive performances, deep learning methods are hard to implement. They require a considerable amount of resources and, unlike simpler models, are much more difficult to visualise and interpret. For one, they require senior data scientists and access to a local server cluster with access to Graphic Processing Units (GPUs) or cloud computing platforms such as Google Cloud, Microsoft Azure or Amazon Web Services. This infrastructure needs time to set up and delays are inevitable, since the data manipulated by public administration deserves a much greater degree of privacy. Besides, such models require a long time to train \sphinxhyphen{} which translates to more expensive models.

\sphinxAtStartPar
Given the policymaker constraints, DL techniques may well be out of time, and budget. Our goal is to satisfy the constraints of a local planner with tight budget and more pressing issues, or the limited options of a private BSS company who needs to sustain high operational costs. We will develop two classes of models, univariate and multivariate, using both statistical and machine\sphinxhyphen{}learning methods. We will also attempt to evaluate the usefulness of external data \sphinxhyphen{} which might be hard to require and process \sphinxhyphen{} and the performances of libraries such as Facebook’s Prophet, which have been specifically designed for ‘forecasting at scale’, i.e. forecasting multiple time\sphinxhyphen{}series (in the order of the thousands) with little to no pre\sphinxhyphen{}processing, feature engineering and simple models.

\sphinxAtStartPar
This experiment has many drawbacks and limitations: as a starter, it does not include a proper spatial analysis, and does not explore Vector Auto Regressive (VAR) models, nor Bayesian models. Our goal is to prove that feature engineering and better data can do a better job at improving a model compared to more advanced techniques, especially under (hypothetically) tight budget constraints. In other words, we might want to get the feel for the marginally decreasing utility of accuracy improvements, which come at progressively greater computational costs.


\section{The Open Source Stack, Transparency and Reproducibility}
\label{\detokenize{01-introduction:the-open-source-stack-transparency-and-reproducibility}}
\sphinxAtStartPar
This is one of the many (millions?) projects to benefit from the existence of the open source community. This project was developed end\sphinxhyphen{}to\sphinxhyphen{}end using open source tools, starting from PostgreSQL to store the data and many Python libraries to train the models. Jupyter Notebooks have been the main developing tool (Perkel, 2018), and Jupyter Books (Executable Books Community, 2020) to convert the code into a \(\LaTeX\) publication, thanks to \sphinxcode{\sphinxupquote{pandoc}} working in the background (Pandoc \sphinxhyphen{} About Pandoc, n.d.).

\sphinxAtStartPar
Zotero was used as a bibliography manager (Zotero | Your Personal Research Assistant, n.d.), and merits are due to several extensions for JupyterLab that made writing on JupyterLab possible: in particular, \sphinxhref{https://github.com/krassowski/jupyterlab-citation-manager}{\sphinxcode{\sphinxupquote{jupyterlab\sphinxhyphen{}citation\sphinxhyphen{}manager}}} was used to insert citations inside notebooks via the official Zotero API, and \sphinxhref{https://github.com/jupyterlab-contrib/spellchecker}{\sphinxcode{\sphinxupquote{jupyterlab\_spellchecker}}} helped in spotting typographic mistakes. Of course, version control with \sphinxcode{\sphinxupquote{git}} and hosting on GitHub played a crucial role in project management. The code is free to see on the dedicated GitHub repository; however, data cannot be accessed due to the terms of the partnership between the provider and the University of Milan. We will try to find the space to introduce and contextualise all the other open source libraries that have been actively used.

\sphinxAtStartPar
There would be much to say about why using open source software, even (and especially) in economics. When it comes down to open source against proprietary software, the differences are not merely technical:
\begin{quote}

\sphinxAtStartPar
There is an independent social dimension, where the metrics assess the interactions between people. Does it increase trust? Does it increase the importance that people attach to a reputation for integrity?
\end{quote}

\sphinxAtStartPar
This is the Economics Nobel Prize Paul Romer (Romer, 2018), now 65, when comparing his experience with Jupyter and Mathematica notebooks. It goes on to make a bold claim:
\begin{quote}

\sphinxAtStartPar
Jupyter exemplifies the social systems that emerged from the Scientific Revolution and the Enlightenment, systems that make it possible for people to cooperate by committing to objective truth; Mathematica exemplifies the horde of new Vandals whose pursuit of private gain threatens a far greater pubic loss – the collapse of social systems that took centuries to build.
\end{quote}

\sphinxAtStartPar
When Romer tried to work with Mathematica notebooks and share their results, it became clear that “Wolfram made it hard to share a readable PDF version of a {[}Mathematica{]} notebook because it wanted someone like me to distribute content in its proprietary file format, the CDF”. The conclusion of his articles are quite dramatic:
\begin{quote}

\sphinxAtStartPar
The tie\sphinxhyphen{}breaker {[}between Wolfram and Jupyter, as well as proprietary and open source{]} is social, not technical. The more I learn about the open source community, the more I trust its members. The more I learn about proprietary software, the more I worry that objective truth might perish from the earth.
\end{quote}

\sphinxAtStartPar
Jupyter Notebooks are being developed since 2001 and they are ever more popular. Perhaps they might even replace the scientific paper (Somers, 2018); what’s sure is that they are ever more present. Indeed, Romer is not the only Nobel prize using open source software: Thomas Sargent, currently 78, uses Julia for his scientific research and launched a website, \sphinxhref{https://quantecon.org/}{QuantEcon} built with Jupyter Books, to teach computational economics in Python and Julia.


\chapter{Bike Sharing and BikeMi: A Literature Review}
\label{\detokenize{02-bikesharing_and_bikemi:bike-sharing-and-bikemi-a-literature-review}}\label{\detokenize{02-bikesharing_and_bikemi::doc}}

\section{A Brief History of Bike Sharing Services}
\label{\detokenize{02-bikesharing_and_bikemi:a-brief-history-of-bike-sharing-services}}
\sphinxAtStartPar
The concept behind bike sharing systems (BSS) has been around since at least the 1960 (DeMaio, 2009). Perhaps unsurprisingly, the first BSS operator was Dutch: it was called Witte Fietsen, or White Bikes, and was deployed in Amsterdam, 1965. The bikes for the sharing service were painted in white, in order to distinguish them from private bicycles, and were made freely available with no locks. Even less surprisingly, “the total absence of security mechanisms led to theft and vandalism, and a rapid demise of Witte Fietsen”, as pointed out by Fishman (Fishman, 2015).

\sphinxAtStartPar
Since this failed attempt, researchers have identified three further generations of bike sharing systems (Parkes et al., 2013), along the lines of their technological improvements. Being one of a kind, Witte Fietsen was basically the only representative of the first generations of bike sharing systems. According to DeMaio, the so\sphinxhyphen{}called second generation of bike sharing system was launched in the 1990s, in Denmark (1991 and 1993) and subsequently in the Netherlands (1995). These systems were designed with better insurances against frequent usage, as well as vandalism: “The Copenhagen bikes were specially designed for intense utilitarian use with solid rubber tires and wheels with advertising plates, and could be picked up and returned at specific locations throughout the central city with a coin deposit” (DeMaio, 2009). These incentives were not enough, as the time was not yet prime for better customer identification technologies as well as tracking systems.

\sphinxAtStartPar
New features such as “electronically\sphinxhyphen{}locking racks or bike locks, telecommunication systems, smart\sphinxhyphen{}cards, mobile phone access, and on\sphinxhyphen{}board computers” became the norm since 1996, following the example of services such as Bikeabout, developed by Portsmouth University in the United Kingdom (DeMaio, 2009). With Bikeabout, students could use a magnetic stripe card to rent a bike. Since then, a couple of third\sphinxhyphen{}generation bike sharing services launched every year across Europe, such as in France (Rennes, 1998) and Germany (Munich, 2000). These services managed to deter theft with “dedicated docking stations (in which bicycles are picked up and returned), as well as automated credit card payment and other technologies to allow the tracking of the bicycles” (Fishman, 2015). The peak of the third generation was reached around the second half of the 2000s, when Velo’v and its 1500\sphinxhyphen{}bike fleet were launched in Lyon in 2005, followed by the 7000 bikes deployed by Velib in 2007 in Paris.

\sphinxAtStartPar
Since then, bike\sphinxhyphen{}sharing spread to the rest of the world, and around the first half of the 2010s China established itself as a leader. In 2014, the global bike\sphinxhyphen{}sharing fleet was estimated at almost one million bicycles, three fourths of which where in China (Fishman, 2015); the country also had more than double the number of bike\sphinxhyphen{}sharing systems (237) compared to Italy (114) and Spain (113), while there were only 54 in the USA (Fishman, 2015). China is now the leader in sharing services, followed by Europe \sphinxhyphen{} which today still maintains its lead over the US, where “the adoption process it at an earlier stage and is gaining momentum” (Parkes et al., 2013).

\sphinxAtStartPar
This ongoing surge in popularity is once again due to technological breakthroughs: the fourth generation of bike sharing services exploits the Global Positioning System (GPS) and smartphones to deploy fleets of dock\sphinxhyphen{}less (or flee\sphinxhyphen{}floating) bikes and e\sphinxhyphen{}bikes. China could establish itself as leader also thanks to the rise of mobile technology and apps like WeChat, which was launched in 2011 and quickly became the most used platform in the country: “By the end of 2015, WeChat had 762 million monthly active users worldwide, and roughly 91\% of them were from China; moreover, around 639 million users accessed WeChat on a smartphone” CHEN 2017. WeChat is ubiquitous in China and living without it nigh impossible (“In Cina vivere senza WeChat è complicato,” 2018), as the platform supports cash transfers and is used for shopping, tipping and paying services.

\sphinxAtStartPar
These new technologies drastically lowered the entrance barriers and the otherwise high upfront investments to set up a bike sharing network. One of the most popular BSS, ofo, was born in 2014 thanks to a collective of students at China’s Peking University, who realised they could use the GPS on user’s phone to track the bikes. They chose the name “ofo” because word itself resembled a biker and brought together some 2000 bikes to use on\sphinxhyphen{}campus (Schmidt, 2018). The service was so popular that they quickly made it into a company.

\sphinxAtStartPar
According to Samantha Herr, executive director of the North American Bikeshare Association in Portland, Maine, “large\sphinxhyphen{}scale venture capital and cheaper equipment are the game changers that propelled the explosive growth of dockless companies like Mobike and ofo”. Dockless bikes are of “lower quality than their docked counterparts” and do not require expensive technologies to interface with a docking station: “That makes them cheaper to mass produce and drop off in new markets” (Schmidt, 2018). It is not by chance that most free\sphinxhyphen{}float BSS are completely private, while docked systems almost always feature a partnership between the private sector and local administrations.

\sphinxAtStartPar
Today, according to the estimates on the website \sphinxhref{https://bikesharingworldmap.com/}{Bike Sharing World Map}, there appear to be almost 1900 bike sharing services in the world, with almost 1000 that have closed down and 300 to be opened. According to an interview to Russell Meddin, the website founder, in 2018 there were 16 to 18 million free\sphinxhyphen{}float bikes, plus 3,7 million docked bikes.


\section{The Challenges of Sharing Services and the Sharing Economy}
\label{\detokenize{02-bikesharing_and_bikemi:the-challenges-of-sharing-services-and-the-sharing-economy}}
\sphinxAtStartPar
Sharing services are not without flaws. For example, Ma and their coauthors warn against some of the worse consequences of the sharing economy as a whole: “exploitative capitalism”, labour precarity, widening income gaps and “platform capitalism” (Ma et al., 2018). The researchers make a dramatic claim: “Left unaddressed, these trade\sphinxhyphen{}offs risk becoming crippling contradictions to the potential of the sharing economy in promoting urban transformations to sustainability” (Ma et al., 2018). This situation represents a great challenge for public administrations, as the pace of innovation is always much faster than policy\sphinxhyphen{}making, and regulating the more controversial aspects of a rapidly growing and popular platform is easier said than done.

\sphinxAtStartPar
Lawmaking takes years: as an example, the two “champions” of the sharing economy, Uber and AirBnB, were valued almost 70 and 30 billion dollars in 2017 (Stone, 2017), despite the press already outlining some of the most controversial aspects of their business models. Uber could never really get past the scandals (Goggin \& Taylor, 2019), especially those concerning the sexist culture of the company (Jackson, 2021), and this played a role in the weak IPO performance of the startup in 2019 (“Nel primo giorno di quotazione in borsa, le azioni di Uber hanno perso il 7,6 per cento,” 2019). In the meantime, other competitors were facing accusations about the legal status of their “riders”, and so did many other companies in the so\sphinxhyphen{}called gig economy, like Deliveroo (the renowned food delivery service). In countries such as Italy, this eventually led to the companies being ordered to recognise the employee status of the workers on the platform, further questioning not only the profitability but also the ethical basis of their business model (Secondo la procura di Milano, Uber Eats, Glovo, Deliveroo e Just Eat devono regolarizzare 60mila rider con contratti di collaborazione, 2021). Legal actions in Italy resulted in the company being placed under external management (Uber Italia è accusata di sfruttamento dei rider ed è stata commissariata, 2020), while in some US States, Uber and its primary competitor, Lyft, are now bound to observe a minimum wage (Seattle ha imposto una paga minima per gli autisti di Uber e Lyft, 2020).

\sphinxAtStartPar
However, these results only came several years later, and the same happened to AirBnB: despite a unexpectedly successful IPO (“La quotazione in borsa di Airbnb è stata un successo,” 2020) in the midst of the pandemic (“La crisi della sharing economy,” 2020), the company now also has to face tighter regulations that undermine their business model (“Airbnb Urges Housing Reform in Berlin after Court Overturns Permit Rejection,” 2017) (“La nuova sentenza europea sugli affitti brevi,” 2020) (“Le città europee contro gli affitti brevi,” 2021).

\sphinxAtStartPar
To a lesser extent, this is a concern for bike\sphinxhyphen{}sharing services as well \sphinxhyphen{} in particular for dockless bike sharing systems, which have undergone an unforeseeable growth in the past five years. As Ma and their coauthors synthesise, the unregulated and unexpected growth of Mobike in Shangai results in hitting “a threshold of oversupply, under\sphinxhyphen{}distribution and user misbehaviour problems, which endanger{[}ed{]} the environmental and social sustainability of innovative urban mobility schemes” (Ma et al., 2018). They proceed to state that “{[}T{]}he social, political and infrastructural institutions in cities have not developed adequate capacities and norms to respond, absorb and adapt to changes brought by under\sphinxhyphen{}regulated commercial and technological forces embodied in the modern sharing economy” (Ma et al., 2018).

\sphinxAtStartPar
The growth of Mobike was so fast that it also “exacerbated problems of user misbehaviour such as theft, vandalism and illegal parking, undermining the sharing values and public space resources that FFBSs require to operate efficiently” (Ma et al., 2018). Besides, this triggered venture capital funds (VC), which flocked to bike\sphinxhyphen{}sharing startups, leading to more than 1,7 million new bikes flooding the streets of Shanghai: “The oversupply of shared bikes created a serious strain on public resources. Massive numbers of bikes were dumped in public spaces, exacerbating existing crowding and stress on the city’s roads and parking spaces” (Ma et al., 2018). The collaboration between private enterprises and public officers began to deteriorate: bikes were ordered to be removed, while new BSS startups “dropped their bikes without any notice in advance” \sphinxhyphen{} a strategy that was also used in other parts of the world. The authors claim that this “unintended tragedy of the commons” was due to “under\sphinxhyphen{}regulated FFBSs”, which had to put their private interests (profitability) first if they wanted to survive the competition (Ma et al., 2018).


\section{The Elephant on the Sidewalk: Electric Scooters}
\label{\detokenize{02-bikesharing_and_bikemi:the-elephant-on-the-sidewalk-electric-scooters}}
\sphinxAtStartPar
Nowadays, bike sharing systems contend roads (and sometimes even sidewalks) with new competitors: electric scooters, or moped, which have become surprisingly popular across the globe in recent years, displaying a stronger growth trend and adoption compared to BSS. The literature on the history of e\sphinxhyphen{}scooters services is still quite young, but authors generally trace the beginning of electric scooter systems (ESS) to 2017, specifically to the US (Yang et al., 2021). Scooters arrived in Europe, specifically in Brussels, during the summer of 2018 (Moreau et al., 2020).

\sphinxAtStartPar
E\sphinxhyphen{}scooters have since developed quite rapidly, even faster than dockless bike sharing services (Yang et al., 2021), and today it is estimated that they make up almost two thirds of the shared micromobility trips in the US, while almost one in four citizens in Paris tried one in 2019 (Yang et al., 2021). However, moped did not come without hassles. For one, “rented and privately\sphinxhyphen{}owned e\sphinxhyphen{}scooters suddenly became a conspicuous, controversial and disruptive presence in urban public space” (Tuncer et al., 2020). Besides, their road status is not quite clear, and legal frameworks are still not ready to adapt to include e\sphinxhyphen{}scooters, which “upset the normal order of traffic and public space” (Tuncer et al., 2020). While they are used at least as widely as bikes (if not more), they do not seem to belong to roads more than skateboards, not to mention sidewalks.

\sphinxAtStartPar
Their advantages are clear: being electric, they can travel longer distances with lesser effort. Besides, scooters are handier and more portable than bikes. There are some disadvantages, too: scooters are electric and thus require charging, which introduces another step in the reallocation procedure. Overall, this entails greater costs for the service providers: while manufacturing costs might be assumed to be equivalent, recharging the batteries and moving them to and from the charging station surely translates into higher operational costs (Zhu et al., 2020). Furthermore, some authors in the literature also find that scooters have a shorter life span and thus “at present, the use of e\sphinxhyphen{}scooters shows a higher impact than the transportation modes they replace” (Moreau et al., 2020). This calculation does not include “end\sphinxhyphen{}of\sphinxhyphen{}life treatment”, which could positively affect their “GWP” or “Global Warming Potential” (Moreau et al., 2020). The authors suggest a list of measures that could reduce their impact, which include increased cooperation with the public sector: “new electric charging stations that are installed in the city could also include charging devices for e\sphinxhyphen{}scooters”; however, the supplier should also provide incentives, for example “a financial incentive for the users to drop the e\sphinxhyphen{}scooter off at charging areas and plug them in” (Moreau et al., 2020).

\sphinxAtStartPar
However, the literature is still too young to coherently assess the impact of e\sphinxhyphen{}scooters and their relationship with existing sharing service and public transport network. For example, it would be deemed reasonable that e\sphinxhyphen{}scooters might provide a good alternative to private transportation, yet “several studies suggest that they are frequently used instead of walking” (Tuncer et al., 2020), as it was found by (Laa \& Leth, 2020), (Mitra \& Hess, 2021), (Nikiforiadis et al., 2021) and (Sanders et al., 2020). Some authors specifically found that “People travelling with bicycle or motorcycle were not attracted by e\sphinxhyphen{}scooters novelty” (Nikiforiadis et al., 2021) or that are more likely to be employed for recreational purposes, “potentially filling a niche” (Sanders et al., 2020). One interesting trend that e\sphinxhyphen{}scooters display is that, after trying the service, some users do buy a scooter of their own (Tuncer et al., 2020), and e\sphinxhyphen{}scooters owners are more likely to use them as a replacement for their private cars (Moreau et al., 2020).

\sphinxAtStartPar
In other words, borrowing from economic jargon, it is still not clear why and when e\sphinxhyphen{}scooters are to be considered substitutes or complements of traditional modes of transport, and the same goes for bike sharing. On the one hand, it seems clear that e\sphinxhyphen{}scooters (and bikes) do not consistently replace private vehicles and cars in particular. By the way, this reinforces the idea that in order to transition towards a greener economy, promoting sharing services must go hand in hand with investments in public transportation networks, as well as improving existing biking infrastructure (Laa \& Leth, 2020).

\sphinxAtStartPar
For one, it might be expected that adoption of e\sphinxhyphen{}scooters translates into a decline in bike rentals. These are the findings of Yang and their coauthors (Yang et al., 2021), who estimated that in Chicago weekly usage of bike sharing in e\sphinxhyphen{}scooter sharing operation area declined by slightly more than 10 percent. Specifically, the usage of bike\sphinxhyphen{}sharing service subscribers was down by 4 percent, while the drop across non\sphinxhyphen{}subscribers was as big as 34 percent (Yang et al., 2021). Indeed, this might reveal that subscribers choose bikes for endogenously different reasons \sphinxhyphen{} i.e., they might deem them better suited for commuting. After all, “bike sharing use during non\sphinxhyphen{}peak hours decreased but was not affected during peak hours” (Yang et al., 2021). The drop was more marked with short trips, for which bike usage was down by almost 11 percent \sphinxhyphen{} twice as much as the decline in medium\sphinxhyphen{}duration trips (5,5) but almost half as much as in short trips (20,5). In general, it seems that docked bikes are preferred for commuting (Reck \& Axhausen, 2021) (Reck et al., 2021).


\section{Sharing Services in Milan: BikeMi and its Competitors}
\label{\detokenize{02-bikesharing_and_bikemi:sharing-services-in-milan-bikemi-and-its-competitors}}
\sphinxAtStartPar
BikeMi was introduced in December 2008 in a partnership between the City of Milan and Clear Channel Italia, a subsidiary of a global media and advertising group. In 2015, pedal assisted bicycles were introduced. Now the service counts 325 stations with 5430 bikes: 4280 are “classic”, 1000 are e\sphinxhyphen{}bikes and 150 are “pedal\sphinxhyphen{}assisted” (i.e., electric) with a child seat (Who We Are \sphinxhyphen{} BikeMi, n.d.). Including private enterprises (fully free\sphinxhyphen{}float), there are a total of 15400 bikes up for sharing, of which 3500 are electric. Private companies were progressively introduced in 2017, after public procurement and a testing phase (Bike Sharing \sphinxhyphen{} Comune Di Milano, 2021).

\sphinxAtStartPar
Mobike was the first, in July 2017, deploying 4000 bikes across Milan and Florence (P.Sol, 2017). ofo joined around the same time and economic Newspaper \sphinxstyleemphasis{il Sole 24 ORE} reported that, by November 2017, MoBike had deployed 8000 bikes in Milan and 7000 more in the rest of Italy, while ofo had 4000 bikes (Magnani, 2017). This resulted in BikeMi losing some 5 percent of their subscribers. ClearChannel, the service provider, disclosed that in 2009 they had some 10700 subscribers, which became around six times as much by 2017. At the time, BikeMi was reported to have 4650 bikes, of which 1000 were electric (Magnani, 2017). Surprisingly, BikeMi was reporting a profit: 200 thousand euros. Operating costs amounted to 6 million euros, two of which were covered by subscriptions and the remainder by advertisement revenue (Magnani, 2017).

\sphinxAtStartPar
The article was also reporting rumours about a fusion between the two private operators, which were undergoing extensive losses and could not be seen reaching the profitability goals they set themselves for the following years. In 2018, ofo was already said to be close to failure, while Mobike was allegedly looking to sell their operations in Europe (Salvioli, 2018). Indeed, ofo failed in 2020, while the Italian Idri Bk (manager of Mobike fleets) bought the European branch of Mobike on November 2019. From the operation, the new sharing service Movi (now RideMovi) was born, after ofo had already withdrawn from the Italian and European market (Soldavini, 2019). Now in Milan there are three bike sharing services: BikeMi is the only docked one, with rentals services open from 7 a.m. to 1 a.m. and from 7 a.m. to 2 a.m. during summer, plus 24 hours on Fridays and Saturdays. The other two services, RideMovi and Lime, are free\sphinxhyphen{}floating and operating 24 hours a day (Bike Sharing \sphinxhyphen{} Comune Di Milano, 2021).

\sphinxAtStartPar
Electric\sphinxhyphen{}scooter sharing services arrived in Milan \sphinxhref{https://www.comune.milano.it/servizi/monopattini-in-sharing}{only on February 2020} (Monopattini in Sharing \sphinxhyphen{} Comune Di Milano, 2021), right before the first wave of the COVID\sphinxhyphen{}19 pandemic and following a one\sphinxhyphen{}year long public procurement. Each provider was allowed a fleet of 750 e\sphinxhyphen{}moped, for a total of 2250 vehicles and three providers. To face the mobility challenges of the pandemic, the cap was increased to 6000 and the number of providers was doubled.


\section{Competitors and Data in Our Analysis}
\label{\detokenize{02-bikesharing_and_bikemi:competitors-and-data-in-our-analysis}}
\sphinxAtStartPar
The history of BikeMi’s competitors has several implications for our analysis. While we will be discussing the data and the choices for our project in the next chapter, it is worth anticipating some points. For one, we can already rule out electric scooters and their effects, as they only appeared in 2020 \sphinxhyphen{} a year for which we would have BikeMi data. However, given the pandemic break out, we chose not to forecast rentals in that period of time.

\sphinxAtStartPar
The situation becomes more complicated when it comes to the other dockless bike\sphinxhyphen{}sharing services. For one, we could not obtain data from any of the other providers, which either failed or sold all their activities to other private enterprises. Not having data about dockless services forces us to change our data strategy, but the literature comes to help. As we have outlined above, several authors found that docked bike\sphinxhyphen{}sharing systems are mostly used for commuting and are less sensitive to the introduction of free\sphinxhyphen{}floating BSS. Since ClearChannel only registered a 5 percent decrease in subscriptions since the FFBSS introduction, we feel reassured when accepting that we will only be able to model FFBSS effects with a dummy variable. After all, in just a few months private operators introduced at least as many bikes as BikeMi had: 4000 for ofo and 4000 for Mobike, which became twice as many in less than six months after the launch of the service. Given these numbers, a decline of only 5 percent does not seem worrisome.

\sphinxAtStartPar
If we buy the “docked bikes services are less sensitive to dockless ones” assumption, i.e. that docked bikes are preferred for commuting, it can be enough to forecast the number of bikes during peak hours. In the next chapter, we will see that peak commuting hours perfectly overlap with peak BikeMi usage. Finally, there is a considerable data gap from July 2018 to the end of that year, which forced us to analyse data from 2015 to that date only. All in all, the instability and novelty of free\sphinxhyphen{}floating bike sharing services has likely dampened their usage growth. For all the reasons outlined so far, we concluded that the lack of ways to account for ofo and Mobike data would not hinder our forecasts significantly. Besides, adopting the policymaker perspective, it would be quite difficult to have your competitor’s data available.


\section{BikeMi: a Review of the Literature}
\label{\detokenize{02-bikesharing_and_bikemi:bikemi-a-review-of-the-literature}}
\sphinxAtStartPar
Saibene and Manzi (Saibene \& Manzi, 2015) analyse survey data to evaluate the level of satisfaction for “all the actors involved”: service management, city council and users. The area taken into consideration was inside the “Bastioni”, i.e. inside of the historic hispanic walls. This area coincides with the so\sphinxhyphen{}called “Area C”, where cars have restricted access since 2012 (and paid access since 2008 with the so\sphinxhyphen{}called “Ecopass”). Sorrentino, Manzi and Virili (Sorrentino et al., 2019) also investigate the “organisational identity” of Clear Channel Italia, the service provider, focusing on the normative and utilitarian dimensions that characterise a public service. In particular, they observe how the “publicness” and “privateness” of BikeMi interact and how public accountability and social impact interact with Clear Channel’s profitability goals.

\sphinxAtStartPar
Toro and his coauthors (Toro et al., 2020) perform a similar analysis with data from June 2015 to December 2018 \sphinxhyphen{} the same period we analyse. They find that the service is “extensively used for commuting to work\sphinxhyphen{}related activities” and that “only strong meteorological conditions can impact the use of the service” (Toro et al., 2020). Indeed, it seems reasonable to assume that commuters are more inelastic to moderately adverse weather, as light rain or cold. The authors also implement a clustering algorithm to analyse bike\sphinxhyphen{}sharing services patterns, a widespread step in the literature \sphinxhyphen{} especially for forecasting about dockless services. The goal of this strategy is to “identify temporal\sphinxhyphen{}spatial patterns for specific users’ typologies” (Toro et al., 2020). They dispose of 13,789,569 records for 3650 traditional bikes and 1150 electric bikes (150 with a child seat). The service operates from 7 a.m. to midnight.

\sphinxAtStartPar
The authors remove all records before the service working hours, as they might inadvertently capture “extraordinary schedules” or maintenance. They do the same for trips whose duration was shorter than a minute and “records whose arrival or departure did not match with the existing stations” (Toro et al., 2020). They identify two types of users, occasional and regular, according to the 75th percentile threshold, i.e. 36 trips, with findings consistent with the literature. Regular users use the service more during weekdays with two different peaks along the day, and occasional users during holidays and weekends, with larger activities at lunchtime and evening hours (Toro et al., 2020).

\sphinxAtStartPar
Through spatial analysis, the researchers confirm that traffic flows from the periphery to the city centre in the mornings and back in the evenings, with greater use in the proximity of train stations. These patterns are also captured by cluster analysis. Looking at the weather, the usage starts to decline “dramatically” only around the 20mm threshold. Also Croci and Rossi (Croci \& Rossi, 2014) find that their results are robust to “confounding factors such as weather conditions”. Their research establishes that “the presence of metro and train stations, universities, museums, cinema and restricted traffic areas in correspondence of bike sharing stations significantly increase use. On the other hand the presence of tram and bus stops and theatres does not and has an opposite influence” (Croci \& Rossi, 2014). Lastly, Cappozzo and their coauthors work on scrapped BikeMi data to classify stations to determine “the future \sphinxstyleemphasis{full}, \sphinxstyleemphasis{empty} or \sphinxstyleemphasis{not problematic}” state of each station (Cappozzo et al., n.d.).


\chapter{BikeMi Data}
\label{\detokenize{03-data_ingestion_and_spatial_operations:bikemi-data}}\label{\detokenize{03-data_ingestion_and_spatial_operations::doc}}

\section{Data Ingestion}
\label{\detokenize{03-data_ingestion_and_spatial_operations:data-ingestion}}
\sphinxAtStartPar
The data was made available thanks to a partnership established by Prof. Giancarlo Manzi of the University of Milan and Clear Channel Italia, the provider of the service. The data is comprised of all the individual trips performed by each client (\sphinxcode{\sphinxupquote{cliente\_anonimizzato}}). This includes the bike type (which can either be a regular bike or an electric bike), the bike identifier, the station of departure and arrival with the time, the duration of the trip \sphinxcode{\sphinxupquote{durata\_noleggio}} plus the total travel distance. We do not know how the total travel distance \sphinxcode{\sphinxupquote{distanza\_totale}} is computed. Here are a selection of fields for the first five rows of the source data (time features are rounded to the daily level to fit into the page):

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
    bici tipo\PYGZus{}bici  cliente\PYGZus{}anonimizzato giorno\PYGZus{}prelievo  \PYGZbs{}
0   8480      Bike                 47869      2015\PYGZhy{}07\PYGZhy{}01   
1   6190      Bike                 74372      2015\PYGZhy{}07\PYGZhy{}01   
2   6000      Bike                105372      2015\PYGZhy{}07\PYGZhy{}01   
3  10538     eBike                103840      2015\PYGZhy{}07\PYGZhy{}01   
4   1981      Bike                 57260      2015\PYGZhy{}07\PYGZhy{}01   

       nome\PYGZus{}stazione\PYGZus{}prelievo giorno\PYGZus{}restituzione nome\PYGZus{}stazione\PYGZus{}restituzione  
0  Arco della Pace 2 \PYGZhy{} Pagano          2015\PYGZhy{}07\PYGZhy{}01       Vercelli \PYGZhy{} Cherubini  
1                  XXV Aprile          2015\PYGZhy{}07\PYGZhy{}01                    Caiazzo  
2                 San Giorgio          2015\PYGZhy{}07\PYGZhy{}01                    Rosario  
3                  XXV Aprile          2015\PYGZhy{}07\PYGZhy{}01                    Caiazzo  
4                  XXV Aprile          2015\PYGZhy{}07\PYGZhy{}01              Sant\PYGZsq{}Ambrogio  
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
The data available ranges from the first of June, 2015, to the first of October, 2020, totalling to 15.842.891 observations. Data was made available in Excel spreadsheets, following the \sphinxhref{https://docs.microsoft.com/en-us/openspecs/office\_standards/ms-xlsx/f780b2d6-8252-4074-9fe3-5d7bc4830968}{Office Open XML SpreadsheetML File Format} (the \sphinxcode{\sphinxupquote{.xlsx}} file format). Python”s Pandas library has methods to read \sphinxcode{\sphinxupquote{.xlsx}} files; however, given how big these files are, data manipulation would have proven unfeasible.

\sphinxAtStartPar
For this reason, we resorted to some useful and popular open source tools, which we used to build \sphinxcode{\sphinxupquote{bash}} scripts and functions to automate conversion from \sphinxcode{\sphinxupquote{.xlsx}} to \sphinxcode{\sphinxupquote{.csv}} files, perform some elementary data cleaning and load the data into a local PostgreSQL database. Format conversion to Comma\sphinxhyphen{}Separated Values (\sphinxcode{\sphinxupquote{.csv}}) was performed using \sphinxhref{https://github.com/wireservice/csvkit}{\sphinxcode{\sphinxupquote{csvkit}}}, a Python package to perform basic operations on \sphinxcode{\sphinxupquote{.csv}} files from the command line. Being written in Python, \sphinxcode{\sphinxupquote{csvkit}} can be slow. However, as part of a major trend for several command\sphinxhyphen{}line applications, \sphinxcode{\sphinxupquote{csvkit}} was rewritten in Rust, a fast and secure programming language whose popularity has been rising in the last couple of years (Perkel, 2020). Much alike Julia (Perkel, 2019), Rust is becoming a tool for data science, as well as scientific computing (for example in bio\sphinxhyphen{}statistics) as it is “a language that offer{[}s{]} the “expressiveness” of Python but the speed of languages such as C and C++” (Perkel, 2020).

\sphinxAtStartPar
The Rust port of \sphinxcode{\sphinxupquote{csvkit}} is called \sphinxhref{https://github.com/BurntSushi/xsv}{\sphinxcode{\sphinxupquote{xsv}}}, and is blazing fast. Much alike \sphinxcode{\sphinxupquote{awk}} (Gawk \sphinxhyphen{} GNU Project \sphinxhyphen{} Free Software Foundation (FSF), n.d.), \sphinxcode{\sphinxupquote{xsv}} can perform filtering operations, but also joins and partitions, as well as computing summary statistics. \sphinxcode{\sphinxupquote{xsv}} does not offer format conversion (yet), but was used to filter out a negligible number of invalid observations from each original \sphinxcode{\sphinxupquote{.xslx}} files (after the conversion to \sphinxcode{\sphinxupquote{.csv}}), and select only the columns that would enter the final dataset.

\sphinxAtStartPar
Finally, \sphinxcode{\sphinxupquote{psql}} (PostgreSQL”s command line utility) was used to upload the “clean” data into a local database instance. PostgreSQL was also used to perform basic survey statistics, like computing the number of rows, and data aggregation (such as counting the number of observations by year). Looking at the frequency tables by year, there appears to be an oddly small number of observations from 2018. This is because there is indeed missing data from June 2018 until the end of the year. For this reason, we chose to work only with data from June 2015 to the end of May 2018.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
        count
date         
2015  1971891
2016  4066783
2017  4272480
2018  1457631
2019  2830566
2020  1243540
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}

\section{Data Analysis}
\label{\detokenize{03-data_ingestion_and_spatial_operations:data-analysis}}
\sphinxAtStartPar
In addition to selecting only trips from June 2015 to June 2018, we also disregard all rentals whose duration is smaller than one minute (around 4000) \sphinxhyphen{} as previously done in the literature (Toro et al., 2020). This leaves us with more than 11,7 million observations. We will temporarily store these in a \sphinxhref{https://www.postgresql.org/docs/current/sql-creatematerializedview.html}{materialised view}, that we will drop at the end of the data analysis.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{create\PYGZus{}materialised\PYGZus{}view}\PYG{p}{(}\PYG{n}{connection}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{k+kc}{None}\PYG{p}{:}

    \PYG{n}{query\PYGZus{}rentals\PYGZus{}before\PYGZus{}2019}\PYG{p}{:} \PYG{n+nb}{str} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{        CREATE MATERIALIZED VIEW IF NOT EXISTS bikemi\PYGZus{}rentals.bikemi\PYGZus{}rentals\PYGZus{}before\PYGZus{}2019 AS}
\PYG{l+s+s2}{        (}
\PYG{l+s+s2}{        SELECT b.bici,}
\PYG{l+s+s2}{               b.tipo\PYGZus{}bici,}
\PYG{l+s+s2}{               b.cliente\PYGZus{}anonimizzato,}
\PYG{l+s+s2}{               DATE\PYGZus{}TRUNC(}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{second}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{, b.data\PYGZus{}prelievo)     AS data\PYGZus{}prelievo,}
\PYG{l+s+s2}{               b.numero\PYGZus{}stazione\PYGZus{}prelievo,}
\PYG{l+s+s2}{               b.nome\PYGZus{}stazione\PYGZus{}prelievo,}
\PYG{l+s+s2}{               DATE\PYGZus{}TRUNC(}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{second}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{, b.data\PYGZus{}restituzione) AS data\PYGZus{}restituzione,}
\PYG{l+s+s2}{               b.numero\PYGZus{}stazione\PYGZus{}restituzione,}
\PYG{l+s+s2}{               b.nome\PYGZus{}stazione\PYGZus{}restituzione,}
\PYG{l+s+s2}{               b.durata\PYGZus{}noleggio}
\PYG{l+s+s2}{        FROM bikemi\PYGZus{}rentals.bikemi\PYGZus{}source\PYGZus{}data b}
\PYG{l+s+s2}{        WHERE EXTRACT(}
\PYG{l+s+s2}{                      }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{year}\PYG{l+s+s2}{\PYGZsq{}}
\PYG{l+s+s2}{                      FROM b.data\PYGZus{}restituzione}
\PYG{l+s+s2}{                  ) \PYGZlt{} 2019}
\PYG{l+s+s2}{          AND durata\PYGZus{}noleggio \PYGZgt{} interval }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{1 minute}\PYG{l+s+s2}{\PYGZsq{}}
\PYG{l+s+s2}{            );}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}

    \PYG{k}{with} \PYG{n}{connection}\PYG{p}{:}
        \PYG{k}{with} \PYG{n}{connection}\PYG{o}{.}\PYG{n}{cursor}\PYG{p}{(}\PYG{p}{)} \PYG{k}{as} \PYG{n}{cursor}\PYG{p}{:}
            \PYG{n}{cursor}\PYG{o}{.}\PYG{n}{execute}\PYG{p}{(}\PYG{n}{query\PYGZus{}rentals\PYGZus{}before\PYGZus{}2019}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The service has almost two\sphinxhyphen{}hundred thousands unique subscribers in the time period. For the years 2016 and 2017, the only ones for which we have complete data, the number of subscribers is almost a hundred thousand. By lookind at the unique subscribers for the other two years, it might seem that the number of subscribers in the second half of the year is higher.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
    count
0  192431
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
      count
anno       
2015  64079
2016  93239
2017  95931
2018  50860
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
It is also of interest to look at the number of rentals of each user, broken down by year. As expected, there are more observations from the years 2016 and 2017 as these are complete years. The great number of usage translates to an average of almost 4 trips per day \sphinxhyphen{} i.e., to reach the first train station and then the workplace.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
                      noleggi\PYGZus{}totali  anno
cliente\PYGZus{}anonimizzato                      
43969                           1478  2017
146640                          1355  2017
40585                           1290  2017
40585                           1263  2016
188391                          1133  2017
165664                          1056  2016
147597                          1042  2016
19515                           1039  2017
97713                           1025  2017
90177                            988  2016
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}

\subsection{Usage Patterns and Origin\sphinxhyphen{}Destination Matrix}
\label{\detokenize{03-data_ingestion_and_spatial_operations:usage-patterns-and-origin-destination-matrix}}
\sphinxAtStartPar
As a starter, it is useful to look at the origin\sphinxhyphen{}destination (OD) matrix, to see which are the most popular starting and departure points. On the aggregate level, the most popular points on the OD matrix are the train stations and sightseeing places such as Duomo.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
       stazione\PYGZus{}prelievo  numero\PYGZus{}noleggi  stazione\PYGZus{}restituzione  \PYGZbs{}
0              Cadorna 3          234694              Cadorna 3   
1                  Duomo          197573                  Duomo   
2                Moscova          139561                Moscova   
3     Garibaldi \PYGZhy{} Sturzo          134243     Garibaldi \PYGZhy{} Sturzo   
4  San Babila \PYGZhy{} RIMOSSA\PYGZhy{}          128261             XXV Aprile   
5             XXV Aprile          127804  San Babila \PYGZhy{} RIMOSSA\PYGZhy{}   
6              Cadorna 1          118692                Cairoli   
7                Cairoli          108717         Palazzo Marino   
8             Centrale 1          107864              Cadorna 1   
9      Coni Zugna Solari           99152                 Cavour   

   numero\PYGZus{}noleggi  
0          234349  
1          202773  
2          140552  
3          129611  
4          129006  
5          127974  
6          113104  
7          103253  
8          102102  
9           98083  
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
The ranking is basically unchanged if we look only at data from Monday to Friday and within “core” commuting hours (say, from 7 to 10 and from 17 to 20). However, trips towards stations become more frequent and destinations such as Moscova are slightly less popular. Indeed, employees might straight bike to Moscova after work to take a sip from their Negroni.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
       stazione\PYGZus{}prelievo  numero\PYGZus{}noleggi  stazione\PYGZus{}restituzione  \PYGZbs{}
0              Cadorna 3          234694              Cadorna 3   
1                  Duomo          197573                  Duomo   
2                Moscova          139561                Moscova   
3     Garibaldi \PYGZhy{} Sturzo          134243     Garibaldi \PYGZhy{} Sturzo   
4  San Babila \PYGZhy{} RIMOSSA\PYGZhy{}          128261             XXV Aprile   
5             XXV Aprile          127804  San Babila \PYGZhy{} RIMOSSA\PYGZhy{}   
6              Cadorna 1          118692                Cairoli   
7                Cairoli          108717         Palazzo Marino   
8             Centrale 1          107864              Cadorna 1   
9      Coni Zugna Solari           99152                 Cavour   

   numero\PYGZus{}noleggi  
0          234349  
1          202773  
2          140552  
3          129611  
4          129006  
5          127974  
6          113104  
7          103253  
8          102102  
9           98083  
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
The behaviour changes if we look ad the individual trips, i.e. if we \sphinxcode{\sphinxupquote{GROUP BY}} both departure and destination stations (\sphinxcode{\sphinxupquote{nome\_stazione\_prelievo}} and \sphinxcode{\sphinxupquote{nome\_stazione\_restituzione}}). To be exact, \sphinxcode{\sphinxupquote{Coni Zugna Solari}} is close to both the station in Porta Genova as well as the Navigli and Darsena, which partly explains its popularity.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
     stazione\PYGZus{}prelievo   stazione\PYGZus{}destinazione  numero\PYGZus{}noleggi
0    Coni Zugna Solari     Napoli \PYGZhy{} Washington           14144
1  Napoli \PYGZhy{} Washington       Coni Zugna Solari           13256
2            Cadorna 3                   Duomo            9363
3                Duomo               Cadorna 3            8903
4    Coni Zugna Solari        Savona \PYGZhy{} Tolstoj            8217
5       Palazzo Marino               Cadorna 3            7436
6           Bertarelli               Cadorna 3            6967
7  Vercelli \PYGZhy{} Piemonte  Roncaglia \PYGZhy{} Washington            6373
8                Piola       Gorini \PYGZhy{} Strambio            6336
9            Cadorna 3           Arcivescovado            6197
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
The same considerations apply when looking at the top trips only within the “core” commuting hours. This reinforces the conclusion that BikeMi is consistently used for commuting purposes.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
     stazione\PYGZus{}prelievo   stazione\PYGZus{}destinazione  numero\PYGZus{}noleggi
0    Coni Zugna Solari     Napoli \PYGZhy{} Washington           14144
1  Napoli \PYGZhy{} Washington       Coni Zugna Solari           13256
2            Cadorna 3                   Duomo            9363
3                Duomo               Cadorna 3            8903
4    Coni Zugna Solari        Savona \PYGZhy{} Tolstoj            8217
5       Palazzo Marino               Cadorna 3            7436
6           Bertarelli               Cadorna 3            6967
7  Vercelli \PYGZhy{} Piemonte  Roncaglia \PYGZhy{} Washington            6373
8                Piola       Gorini \PYGZhy{} Strambio            6336
9            Cadorna 3           Arcivescovado            6197
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}

\section{Spatial Data Analysis}
\label{\detokenize{03-data_ingestion_and_spatial_operations:spatial-data-analysis}}
\sphinxAtStartPar
On its open data portal, the Comune di Milano publishes all sorts of open data \sphinxhyphen{} like the daily entrances in the so\sphinxhyphen{}called Area C, where access to private cars is limited. On this treasure trove of data, we can also find things like the location of column fountains and newsstands, but also the geo\sphinxhyphen{}referenced data of bike tracks and the location of \sphinxhref{https://dati.comune.milano.it/it/dataset/ds65\_infogeo\_aree\_sosta\_bike\_sharing\_localizzazione\_}{BikeMi Stations}. As noted previously, the service has some 320 stations, spread unevenly across the town, as it was outlined by previous studies (Saibene \& Manzi, 2015). As a starter, we filter out all stations that have been introduced after 2019. This leaves us with 281 official stations, versus 279 in the historic data.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
                                  nome  municipio  anno  \PYGZbs{}
numero\PYGZus{}stazione                                           
001                              Duomo          1  2008   
402                     San Babila Bis          1  2008   
003                          Cadorna 1          1  2008   
004                              Lanza          1  2008   
005              Universita\PYGZsq{} Cattolica          1  2008   

                          stalls\PYGZus{}geometry  
numero\PYGZus{}stazione                            
001              POINT (9.18914 45.46475)  
402              POINT (9.19725 45.46627)  
003              POINT (9.17566 45.46800)  
004              POINT (9.18197 45.47227)  
005              POINT (9.17641 45.46312)  
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
The data is represented with the (geographic) coordinate reference system (CRS) \sphinxcode{\sphinxupquote{EPSG:4326}}, but in order to use the \sphinxcode{\sphinxupquote{contextily}} library we need to cast it to the (projected) reference system \sphinxcode{\sphinxupquote{EPSG:3587}}. As the map shows, the stalls stretch to the North, towards Bicocca and Sesto San Giovanni. We can already see that the stalls distribution outside the city centre follows bike lanes (in blue).

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{03-data_ingestion_and_spatial_operations_28_0}.png}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}

\subsection{Inspecting Stations with Zero Daily Rentals}
\label{\detokenize{03-data_ingestion_and_spatial_operations:inspecting-stations-with-zero-daily-rentals}}
\sphinxAtStartPar
The stalls in the outer stations are not as used as the ones in the city centre, which come up as an abundance of zeros in the data aggregated at daily and hourly level. Some of these stations are practically unused. Besides, the great count of stations would represent a problem in the context of multivariate regressions (the so\sphinxhyphen{}called \(p > n\) problem). Hence, we can drop the unused stations from our data to help us reduce the dimensionality.

\sphinxAtStartPar
We start by creating another two \sphinxcode{\sphinxupquote{materialised views}} with the daily and hourly rentals, by station. Since the service is only active between 7 and 24, we just keep hourly observations within that time span. If we simply were to \sphinxcode{\sphinxupquote{GROUP BY}} station names and time units, we would obtain series with gaps in the time index. We first create a table with all possible combinations of stations and dates using a \sphinxcode{\sphinxupquote{CROSS JOIN}} and a common table expression (or \sphinxcode{\sphinxupquote{CTE}}), then left join on this table the values obtained via the \sphinxcode{\sphinxupquote{GROUP BY}} on the reference table. A similar query is used to obtain the hourly rentals, with hourly time intervals instead of daily ones.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{create\PYGZus{}rentals\PYGZus{}materialized\PYGZus{}views}\PYG{p}{(}\PYG{n}{connection}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{k+kc}{None}\PYG{p}{:}
    
    \PYG{n}{query\PYGZus{}daily\PYGZus{}rentals}\PYG{p}{:} \PYG{n+nb}{str} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{        CREATE MATERIALIZED VIEW IF NOT EXISTS bikemi\PYGZus{}rentals.daily\PYGZus{}rentals\PYGZus{}before\PYGZus{}2019 AS}
\PYG{l+s+s2}{        (}
\PYG{l+s+s2}{        WITH cross\PYGZus{}table AS (}
\PYG{l+s+s2}{            SELECT d.date AS data\PYGZus{}partenza,}
\PYG{l+s+s2}{                   s.nome AS stazione\PYGZus{}partenza,}
\PYG{l+s+s2}{                   s.numero\PYGZus{}stazione}
\PYG{l+s+s2}{            FROM (}
\PYG{l+s+s2}{                     SELECT *}
\PYG{l+s+s2}{                     FROM bikemi\PYGZus{}rentals.bikemi\PYGZus{}stations}
\PYG{l+s+s2}{                     WHERE anno \PYGZlt{} 2019}
\PYG{l+s+s2}{                 ) s}
\PYG{l+s+s2}{                     CROSS JOIN (}
\PYG{l+s+s2}{                SELECT generate\PYGZus{}series(}
\PYG{l+s+s2}{                               timestamp }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{2015\PYGZhy{}06\PYGZhy{}01}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{,}
\PYG{l+s+s2}{                               timestamp }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{2018\PYGZhy{}06\PYGZhy{}01}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{,}
\PYG{l+s+s2}{                               interval }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{1 day}\PYG{l+s+s2}{\PYGZsq{}}
\PYG{l+s+s2}{                           )::date}
\PYG{l+s+s2}{            ) d(date)}
\PYG{l+s+s2}{            ORDER BY nome,}
\PYG{l+s+s2}{                     date}
\PYG{l+s+s2}{        )}
\PYG{l+s+s2}{        SELECT c.data\PYGZus{}partenza,}
\PYG{l+s+s2}{               c.stazione\PYGZus{}partenza,}
\PYG{l+s+s2}{               c.numero\PYGZus{}stazione,}
\PYG{l+s+s2}{               COUNT(b.*)::smallint AS noleggi\PYGZus{}giornalieri}
\PYG{l+s+s2}{        FROM cross\PYGZus{}table c}
\PYG{l+s+s2}{                 LEFT JOIN bikemi\PYGZus{}rentals.bikemi\PYGZus{}rentals\PYGZus{}before\PYGZus{}2019 b ON b.numero\PYGZus{}stazione\PYGZus{}prelievo = c.numero\PYGZus{}stazione}
\PYG{l+s+s2}{            AND DATE\PYGZus{}TRUNC(}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{day}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{, b.data\PYGZus{}prelievo)::date = c.data\PYGZus{}partenza}
\PYG{l+s+s2}{        GROUP BY c.data\PYGZus{}partenza,}
\PYG{l+s+s2}{                 c.stazione\PYGZus{}partenza,}
\PYG{l+s+s2}{                 c.numero\PYGZus{}stazione}
\PYG{l+s+s2}{        ORDER BY stazione\PYGZus{}partenza,}
\PYG{l+s+s2}{                 data\PYGZus{}partenza}
\PYG{l+s+s2}{            );}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{n}{query\PYGZus{}hourly\PYGZus{}rentals}\PYG{p}{:} \PYG{n+nb}{str} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{    CREATE MATERIALIZED VIEW IF NOT EXISTS bikemi\PYGZus{}rentals.hourly\PYGZus{}rentals\PYGZus{}before\PYGZus{}2019 AS}
\PYG{l+s+s2}{    (}
\PYG{l+s+s2}{    WITH cross\PYGZus{}table AS (}
\PYG{l+s+s2}{        SELECT d.date\PYGZus{}time AS data\PYGZus{}partenza,}
\PYG{l+s+s2}{               s.nome      AS stazione\PYGZus{}partenza,}
\PYG{l+s+s2}{               s.numero\PYGZus{}stazione}
\PYG{l+s+s2}{        FROM (}
\PYG{l+s+s2}{                 SELECT *}
\PYG{l+s+s2}{                 FROM bikemi\PYGZus{}rentals.bikemi\PYGZus{}stations}
\PYG{l+s+s2}{                 WHERE anno \PYGZlt{} 2019}
\PYG{l+s+s2}{             ) s}
\PYG{l+s+s2}{                 CROSS JOIN (}
\PYG{l+s+s2}{            SELECT generate\PYGZus{}series(}
\PYG{l+s+s2}{                           timestamp }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{2015\PYGZhy{}06\PYGZhy{}01}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{,}
\PYG{l+s+s2}{                           timestamp }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{2018\PYGZhy{}06\PYGZhy{}01}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{,}
\PYG{l+s+s2}{                           interval }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{1 hour}\PYG{l+s+s2}{\PYGZsq{}}
\PYG{l+s+s2}{                       )::timestamp}
\PYG{l+s+s2}{        ) d(date\PYGZus{}time)}
\PYG{l+s+s2}{        WHERE EXTRACT(}
\PYG{l+s+s2}{                      }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{hour}\PYG{l+s+s2}{\PYGZsq{}}
\PYG{l+s+s2}{                      FROM d.date\PYGZus{}time}
\PYG{l+s+s2}{                  ) BETWEEN 7 and 24}
\PYG{l+s+s2}{        ORDER BY nome,}
\PYG{l+s+s2}{                 date\PYGZus{}time}
\PYG{l+s+s2}{    )}
\PYG{l+s+s2}{    SELECT c.data\PYGZus{}partenza,}
\PYG{l+s+s2}{           c.stazione\PYGZus{}partenza,}
\PYG{l+s+s2}{           c.numero\PYGZus{}stazione,}
\PYG{l+s+s2}{           COUNT(b.*)::smallint AS noleggi\PYGZus{}per\PYGZus{}ora}
\PYG{l+s+s2}{    FROM cross\PYGZus{}table c}
\PYG{l+s+s2}{             LEFT JOIN bikemi\PYGZus{}rentals.bikemi\PYGZus{}rentals\PYGZus{}before\PYGZus{}2019 b ON b.numero\PYGZus{}stazione\PYGZus{}prelievo = c.numero\PYGZus{}stazione}
\PYG{l+s+s2}{        AND DATE\PYGZus{}TRUNC(}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{hour}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{, b.data\PYGZus{}prelievo)::timestamp = c.data\PYGZus{}partenza}
\PYG{l+s+s2}{    GROUP BY c.data\PYGZus{}partenza,}
\PYG{l+s+s2}{             c.stazione\PYGZus{}partenza,}
\PYG{l+s+s2}{             c.numero\PYGZus{}stazione}
\PYG{l+s+s2}{    ORDER BY stazione\PYGZus{}partenza,}
\PYG{l+s+s2}{             data\PYGZus{}partenza}
\PYG{l+s+s2}{        );}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    
    \PYG{k}{with} \PYG{n}{connection}\PYG{p}{:}
        \PYG{k}{with} \PYG{n}{connection}\PYG{o}{.}\PYG{n}{cursor}\PYG{p}{(}\PYG{p}{)} \PYG{k}{as} \PYG{n}{cursor}\PYG{p}{:}
            \PYG{n}{cursor}\PYG{o}{.}\PYG{n}{execute}\PYG{p}{(}\PYG{n}{query\PYGZus{}daily\PYGZus{}rentals}\PYG{p}{)}
            \PYG{n}{cursor}\PYG{o}{.}\PYG{n}{execute}\PYG{p}{(}\PYG{n}{query\PYGZus{}hourly\PYGZus{}rentals}\PYG{p}{)}
\end{sphinxVerbatim}

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{retrieve\PYGZus{}daily\PYGZus{}rentals}\PYG{p}{(}\PYG{n}{connection}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{:}
    \PYG{n}{query} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+s2}{        SELECT * FROM daily\PYGZus{}rentals\PYGZus{}before\PYGZus{}2019;}
\PYG{l+s+s2}{    }\PYG{l+s+s2}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{k}{return} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{read\PYGZus{}sql}\PYG{p}{(}\PYG{n}{query}\PYG{p}{,} \PYG{n}{connection}\PYG{p}{)}\PYG{o}{.}\PYG{n}{set\PYGZus{}index}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{data\PYGZus{}partenza}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{daily\PYGZus{}rentals} \PYG{o}{=} \PYG{n}{retrieve\PYGZus{}daily\PYGZus{}rentals}\PYG{p}{(}\PYG{n}{conn}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
Then, we compute the number of null values in the data (\sphinxcode{\sphinxupquote{null\_obs}}), pivot the table to wider format and compute the percentage of missing values in each station (\sphinxcode{\sphinxupquote{null\_obs}}). Using Pandas”\sphinxcode{\sphinxupquote{cut()}} method, we can convert this numerical column into a categorical variable (\sphinxcode{\sphinxupquote{null\_obs\_ranking}}) and choose the number of levels \sphinxhyphen{} five, in our case \sphinxhyphen{} to split the column into even intervals with.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{obs\PYGZus{}number} \PYG{o}{=} \PYG{n}{daily\PYGZus{}rentals}\PYG{o}{.}\PYG{n}{index}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}

\PYG{n}{stations\PYGZus{}missing\PYGZus{}obs} \PYG{o}{=} \PYG{p}{(}
    \PYG{n}{daily\PYGZus{}rentals}\PYG{p}{[}\PYG{p}{[}\PYG{n}{col} \PYG{k}{for} \PYG{n}{col} \PYG{o+ow}{in} \PYG{n}{daily\PYGZus{}rentals}\PYG{o}{.}\PYG{n}{columns} \PYG{k}{if} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{numero\PYGZus{}stazione}\PYG{l+s+s2}{\PYGZdq{}} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{col}\PYG{p}{]}\PYG{p}{]}
        \PYG{o}{.}\PYG{n}{pivot}\PYG{p}{(}\PYG{n}{columns}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{stazione\PYGZus{}partenza}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{o}{.}\PYG{n}{replace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nan}\PYG{p}{)}
        \PYG{o}{.}\PYG{n}{isna}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{)}
        \PYG{o}{.}\PYG{n}{sort\PYGZus{}values}\PYG{p}{(}\PYG{n}{ascending}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
        \PYG{o}{.}\PYG{n}{pipe}\PYG{p}{(}\PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} drop the redundant index}
        \PYG{o}{.}\PYG{n}{droplevel}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{o}{.}\PYG{n}{rename}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+m+mi}{0}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{null\PYGZus{}obs}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} create the \PYGZpc{} by dividing the number of null values by the length of the datetime idnex}
        \PYG{o}{.}\PYG{n}{assign}\PYG{p}{(}\PYG{n}{pct\PYGZus{}null}\PYG{o}{=}\PYG{k}{lambda} \PYG{n}{x}\PYG{p}{:} \PYG{n}{x}\PYG{o}{.}\PYG{n}{null\PYGZus{}obs} \PYG{o}{/} \PYG{n}{obs\PYGZus{}number}\PYG{p}{)}
\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} labels for the categorical variable, assumed to be ascending order}
\PYG{n}{labels} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{very\PYGZus{}low}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{low}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{average}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{high}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{very\PYGZus{}high}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{n}{stations\PYGZus{}missing\PYGZus{}obs}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{null\PYGZus{}obs\PYGZus{}ranking}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{cut}\PYG{p}{(}
    \PYG{n}{stations\PYGZus{}missing\PYGZus{}obs}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{pct\PYGZus{}null}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{labels}\PYG{o}{=}\PYG{n}{labels}
\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
In this way, we can see that the number of stations with an “unacceptable” number of missing values is smaller than thirty.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{03-data_ingestion_and_spatial_operations_36_0}.png}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
More than 80 percent of the stations display a count of null observations inferior to 20 percent.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{03-data_ingestion_and_spatial_operations_38_0}.png}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
We can also join this data with the station spatial data to plot them. While this does not expose patterns that could be used to reduce the dimensionality of the data, it shows that there are some stations that need to be dropped off even from the most crowded areas in the city. This could not be spotted before as, to the best of our knowledge, no one in the BikeMi literature has ever found a way to take into account of how public work on roads and infrastructure had effects on the bike sharing service.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{03-data_ingestion_and_spatial_operations_40_0}.png}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}

\subsection{Area of Analysis}
\label{\detokenize{03-data_ingestion_and_spatial_operations:area-of-analysis}}
\sphinxAtStartPar
Besides dropping the “emptiest” stations, we should also come up with a way to narrow down the geographic area inside which we perform the analysis. Previously, authors have chosen to analyse just the area inside the Bastioni, or “Area C” (Saibene \& Manzi, 2015) or the whole set of stations (Toro et al., 2020). This was mainly due to the different purpose of their analysis and the data availability (Saibene and Manzi analyse data from 2008 to 2012). For our goal, as well as the policymaker perspective, this choice seems restricting, as it leaves out most of the train stations. It is worth noting that analysing the bike sharing traffic inside of Area C can be appropriate: for example, since, the municipality publishes the number of daily accesses to the area, which could be used to evaluate the effect of sharing services on traffic.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{03-data_ingestion_and_spatial_operations_43_0}.png}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
The area we propose is the road ring across Milan, informally referred to as Circonvallazione. This area encapsulates the city centre, as well as most of the train stations, and is represented by the green shade in the map below. This is arguably limiting, as the area does not take in Lambrate and Villapizzone/Bovisa train stations. However, one might argue that it is unlikely for to choose to go to Lambrate and then rent a bike to get to the city centre, as they can just get to Centrale; the same goes for the other stations. In other words, this area contains the sufficient amount of stations to provide a useful forecast for the policymaker, albeit neglecting the outer stalls.

\sphinxAtStartPar
This approach might just reinforce the bias towards the centre of the city, but given the technical constraints seems to be the more viable option. However, as a comparison, the Area C would only contain one train station, whereas this area contains all of the top rentals stalls from the origin\sphinxhyphen{}destination (OD) matrix.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\end{sphinxuseclass}
\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{03-data_ingestion_and_spatial_operations_46_0}.png}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
This leaves us with the following stations, which we store as a \sphinxcode{\sphinxupquote{.csv}} file and then upload into our local PostgreSQL database with a Bash script.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{03-data_ingestion_and_spatial_operations_48_0}.png}

\end{sphinxuseclass}
\end{sphinxuseclass}
\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{tag_hide-input}
\end{sphinxuseclass}
\end{sphinxuseclass}

\chapter{BikeMi Stalls \sphinxstyleemphasis{k}\sphinxhyphen{}Means Clustering}
\label{\detokenize{04-stations_kmeans:bikemi-stalls-k-means-clustering}}\label{\detokenize{04-stations_kmeans::doc}}

\section{\sphinxstyleemphasis{k}\sphinxhyphen{}Means Clustering Review}
\label{\detokenize{04-stations_kmeans:k-means-clustering-review}}
\sphinxAtStartPar
After our first data selection to remove outliers and restrict the spatial area in which we are conducting our analysis,
we are still left with more than 200 stations, spread across 25 neighbourhoods out of 88 \sphinxhyphen{} identified by the acronym NIL, i.e. \sphinxstyleemphasis{nuclei d’identità locale}. This figure might still be too high, especially as far as multivariate models are concerned: indeed, shrinkage will be necessary in order to avoid highly correlated features (\sphinxstyleemphasis{multicollinearity}).
However, it is still in our interests to reduce the number of series to model even for the univariate forecasting: fitting twenty or two\sphinxhyphen{}hundred series is a different task. Even inspecting the correlation across series becomes a daunting task with such a great number of features.

\sphinxAtStartPar
To do so, we will use \sphinxstyleemphasis{k}\sphinxhyphen{}means clustering \sphinxhyphen{} a popular method widely used in the sharing\sphinxhyphen{}services literature, especially to identify “virtual stations” in free\sphinxhyphen{}float services (Ma et al., 2018) or to “visualize the spatial distribution of DBS {[}Dockless Bike Sharing{]} and taxis around metro stations” (Li et al., 2019).

\sphinxAtStartPar
In a few words, with \sphinxstyleemphasis{k}\sphinxhyphen{}means clustering  we “want to partition the observations into \(K\) clusters such that the total within\sphinxhyphen{}cluster variation {[}also known as  \sphinxstyleemphasis{inertia}{]}, summed over all \(K\) clusters, is as small as possible” (Sohil et al., 2021). The objective function to optimise is usually the squared Euclidean distance. Simply put, \sphinxstyleemphasis{k}\sphinxhyphen{}means “aims to partition n observations into \(K\) clusters, represented by their centres or means. The centre of each cluster is calculated as the mean of all the instances belonging to that cluster” (Li et al., 2019) and “is extremely efficient and concise for the classification of equivalent multidimensional data” such as sharing services data (Li et al., 2019).

\sphinxAtStartPar
The algorithm begins with randomly choosing clusters centres and, with each iteration, the centres are re\sphinxhyphen{}calculated to reduce the partitioning error \sphinxhyphen{} which decreases monotonically, as \(K\) increases. Basically, in this second step the algorithm “creates new centroids by taking the mean value of all of the samples assigned to each previous centroid {[}…{]} until the centroids do not move significantly” (Clustering, n.d.). However, despite similarity always increasing, values of \(K\) that are too great defy the purpose of this classification algorithm. For this reasons, practitioners and researchers have come up with more or less sophisticated ways to assess the optimal number of clusters, the most common of which is the so\sphinxhyphen{}called “Elbow method”. In a few words, a chosen performance metric is computed for each number of clusters and the optimum is represented by the point at which the performance improvements start to marginally decline.

\sphinxAtStartPar
\sphinxstyleemphasis{k}\sphinxhyphen{}Means clustering scales well with the number of samples \(n\), but assumes convex shapes (i.e., has worse performances where the “true” clusters have elongated or irregular shapes) (Clustering, n.d.). Besides, since the initial position of the cluster is random, it might take some attempt for the algorithm to converge. More importantly, however, \sphinxstyleemphasis{k}\sphinxhyphen{}Means is sensitive to the scales of the variables in the data, so normalising the feature matrix is a crucial step. Finally, \sphinxstyleemphasis{k}\sphinxhyphen{}Means assumes continuous data and is not designed to handle categorical features: “{[}T{]}he \sphinxstyleemphasis{k}\sphinxhyphen{}means algorithm only works on numerical data, i.e. variables that are measured on a ratio scale {[}…{]}, because it minimises a cost function by changing the means of clusters. This prohibits it from being used in applications where categorical data are involved” (Huang, 1998).

\sphinxAtStartPar
Some workarounds have long been studied in the literature: as an example, by changing the distance metrics from the Euclidean distance to the Gower distance, which is a measure of similarity (Gower, 1971), \sphinxstyleemphasis{k}\sphinxhyphen{}Means can be adjusted to cluster categorical variables. As an alternative, new methods have been developed, such as the \sphinxstyleemphasis{k}\sphinxhyphen{}Modes (Huang, 1998). These alternative methods rose in popularity because the “quadratic computational costs” of similarity\sphinxhyphen{}based algorithms are not suited for the larger and larger datasets we have been dealing with, especially in the past years.

\sphinxAtStartPar
Our context does not warrant new, sophisticated clustering algorithms. The sample size of the spatial distribution of stalls would even be small enough to justify an attempt with similarity scores. Yet, to the best of our knowledge, this procedure has not been tried yet in the literature, and there are plenty of good reasons for doing so.

\sphinxAtStartPar
As a starter, the categorical variables we have \sphinxhyphen{} like the neighbourhood \sphinxhyphen{} are just another measure of geographic distribution. It would be much more meaningful to run the \sphinxstyleemphasis{k}\sphinxhyphen{}means algorithm with other, quantitative features, such as the number of stations or bike lanes in the proximity of the station. The nature and number of buildings, like the extension of parks or traffic measurements, could be used, too. This procedure of data collection should take a lot of time and diversified skills and would primarily accomplish the goal to provide a better segmentation of the individual stations: as an example, it could represent an improvement over choosing neighbourhood fixed effects. While the level of accuracy of such an approach could be much greater, this is nothing that would not be similarly accomplished by “arbitrarily” selecting stations close to each other (say, within a radius of a couple of hundred metres, or that varies according to the population density of the area). Given the nature of our task \sphinxhyphen{} forecasting \sphinxhyphen{} we shall stick to the usage of \sphinxstyleemphasis{k}\sphinxhyphen{}means that is prevalent in the literature: identify virtual stations to reduce dimensionality and perhaps offer new insights as far as data analysis is concerned.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics} \PYG{k+kn}{import} \PYG{n}{silhouette\PYGZus{}score}\PYG{p}{,} \PYG{n}{davies\PYGZus{}bouldin\PYGZus{}score}\PYG{p}{,} \PYG{n}{calinski\PYGZus{}harabasz\PYGZus{}score}
\PYG{k+kn}{from} \PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{preprocessing} \PYG{k+kn}{import} \PYG{n}{StandardScaler}
\PYG{k+kn}{from} \PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{cluster} \PYG{k+kn}{import} \PYG{n}{KMeans}
\PYG{k+kn}{from} \PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{pipeline} \PYG{k+kn}{import} \PYG{n}{make\PYGZus{}pipeline}


\PYG{k}{def} \PYG{n+nf}{filter\PYGZus{}coords}\PYG{p}{(}\PYG{n}{data}\PYG{p}{:} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{,} \PYG{n}{cols}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{:}
    \PYG{k}{if} \PYG{n}{cols} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{cols} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{longitudine}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{latitudine}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{k}{return} \PYG{n}{data}\PYG{o}{.}\PYG{n}{filter}\PYG{p}{(}\PYG{n}{cols}\PYG{p}{)}


\PYG{n}{selected\PYGZus{}stalls\PYGZus{}lonlat}\PYG{p}{:} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame} \PYG{o}{=} \PYG{n}{bikemi\PYGZus{}selected\PYGZus{}stalls}\PYG{o}{.}\PYG{n}{pipe}\PYG{p}{(}\PYG{n}{filter\PYGZus{}coords}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}

\section{\sphinxstyleemphasis{k}\sphinxhyphen{}Means Clustering Evaluation Metrics}
\label{\detokenize{04-stations_kmeans:k-means-clustering-evaluation-metrics}}
\sphinxAtStartPar
The main, if not only, hyperparameter to tune in \sphinxstyleemphasis{k}\sphinxhyphen{}means is, indeed, the number of clusters.
As most machine learning methods, \sphinxstyleemphasis{k}\sphinxhyphen{}means is a quite old algorithm and has thus been widely studied.
The first metric to look at is indeed the inertia, or \sphinxstyleemphasis{within\sphinxhyphen{}cluster sum\sphinxhyphen{}of\sphinxhyphen{}squares} (\(WSS\)), which is usually computed using the Euclidean norm:
\begin{equation*}
\begin{split}
\sum_{i=0}^{n}\underset{\mu_{j}\in{C}}{min}(||x_{i} - \mu_{j}||^2)
\end{split}
\end{equation*}
\sphinxAtStartPar
Other norms can be used; however, some other performance metrics can only be calculated with the Euclidean distance. While clustering is usually presented as an unsupervised machine\sphinxhyphen{}learning technique, a first set of metrics is actually computed comparing the clustering with the ground truths. This is necessary because the evaluation metrics should not take into account the absolute number of clusters, yet if this clustering defines “separations of the data similar to some ground truth set of classes” (Clustering, n.d.).

\sphinxAtStartPar
Among these metrics there are the \sphinxstyleemphasis{Rand index}, mutual information\sphinxhyphen{}based scores, measures of completeness and homogeneity (or both, such as the \sphinxstyleemphasis{V\sphinxhyphen{}measure}) and Fowlkes\sphinxhyphen{}Mallows scores. There is, however, another category of metrics that does not require a comparison with the ground\sphinxhyphen{}truth: the \sphinxstyleemphasis{silhouette coefficients}, the \sphinxstyleemphasis{Calinski\sphinxhyphen{}Harabasz index}, computed as  and  the \sphinxstyleemphasis{Davies\sphinxhyphen{}Bouldin index}. The dowside of these evaluation metrics is that they are not robust against “unconventional” shapes and tend to display “better” values when the clusters are convex.

\sphinxAtStartPar
These measures are computed for each set of data points and the labels assigned with the \sphinxstyleemphasis{k}\sphinxhyphen{}means. The silhouette score is computed as \(s = \frac{b - a}{max(a, b)}\), where \(a\) is the mean distance between a sample and all points in the same class and \(b\) is the average distance between the sample and the points in the \sphinxstyleemphasis{next nearest} cluster. The silhouette coefficients for all samples are averaged and a higher silhouette coefficient relates to a model with better defined clusters (Clustering, n.d.). For this reason, the silhouette score is defined within \([-1;1]\), and scores closer to \(-1\) denote incorrect clustering and values near \(0\) indicate overlapping data points.

\sphinxAtStartPar
The Calinski\sphinxhyphen{}Harabasz Index is defined as:
\begin{equation*}
\begin{split}
s = \frac{\mathrm{tr}(B_k)}{\mathrm{tr}(W_k)} \times \frac{n_E - k}{k - 1}
\end{split}
\end{equation*}
\sphinxAtStartPar
Where \(B_k\) is the dispersion between clusters and \(W_k\) is the one within clusters and \(n\) is the number of observations in the dataset \(E\). Because of this, the index is a raw number (i.e., it is not normalised between, say, \(0\) and \(1\)). Since we want the clusters to be as far apart as possible and the points inside to be as close as possible, we will choose \(K\) such as it maximises the Calinski\sphinxhyphen{}Harabasz index.

\sphinxAtStartPar
Finally, the Davies\sphinxhyphen{}Bouldin index indicates a better separation between clusters the lower it is, and is computed as the average similarity across the two closer classes \(C_i\) and \(C_k\). The similarity measure between \(C_i\) and \(C_k\) is called \(R_{ij}\) and is defined as \(R_{ij} = \frac{s_i + s_j}{d_{ij}}\), where \(s\) is the average distance between each point of a cluster and its centre, and \$d\_\{ij\} is the distance between the two clusters’ centroids. The Davies\sphinxhyphen{}Bouldin index is thus formally defined as such:
\begin{equation*}
\begin{split}
DB = \frac{1}{k} \sum_{i=1}^k \max_{i \neq j} R_{ij}
\end{split}
\end{equation*}

\section{Fitting \sphinxstyleemphasis{k}\sphinxhyphen{}Means on BikeMi Stalls Geographic Data}
\label{\detokenize{04-stations_kmeans:fitting-k-means-on-bikemi-stalls-geographic-data}}
\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}kmeans\PYGZus{}metrics}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{k\PYGZus{}max}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{:}
    \PYG{n}{scaled\PYGZus{}data} \PYG{o}{=} \PYG{n}{StandardScaler}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{fit\PYGZus{}transform}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}
    \PYG{n}{k\PYGZus{}range} \PYG{o}{=} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{k\PYGZus{}max} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}

    \PYG{n}{Metrics} \PYG{o}{=} \PYG{n+nb}{tuple}\PYG{p}{[}\PYG{n+nb}{float}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{]}

    \PYG{k}{def} \PYG{n+nf}{compute\PYGZus{}scores}\PYG{p}{(}\PYG{n}{source\PYGZus{}data}\PYG{p}{,} \PYG{n}{num\PYGZus{}clusters}\PYG{p}{,} \PYG{n}{rand}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{Metrics}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} fit kmeans}
        \PYG{n}{kmeans} \PYG{o}{=} \PYG{n}{KMeans}\PYG{p}{(}\PYG{n}{num\PYGZus{}clusters}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{n}{rand}\PYG{p}{)}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{source\PYGZus{}data}\PYG{p}{)}

        \PYG{c+c1}{\PYGZsh{} scores}
        \PYG{n}{inertia} \PYG{o}{=} \PYG{n}{kmeans}\PYG{o}{.}\PYG{n}{inertia\PYGZus{}}
        \PYG{n}{silhouette\PYGZus{}coefficient} \PYG{o}{=} \PYG{n}{silhouette\PYGZus{}score}\PYG{p}{(}\PYG{n}{source\PYGZus{}data}\PYG{p}{,} \PYG{n}{kmeans}\PYG{o}{.}\PYG{n}{labels\PYGZus{}}\PYG{p}{,} \PYG{n}{metric}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{euclidean}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{calinski\PYGZus{}harabasz} \PYG{o}{=} \PYG{n}{calinski\PYGZus{}harabasz\PYGZus{}score}\PYG{p}{(}\PYG{n}{source\PYGZus{}data}\PYG{p}{,} \PYG{n}{kmeans}\PYG{o}{.}\PYG{n}{labels\PYGZus{}}\PYG{p}{)}
        \PYG{n}{davies\PYGZus{}bouldin} \PYG{o}{=} \PYG{n}{davies\PYGZus{}bouldin\PYGZus{}score}\PYG{p}{(}\PYG{n}{source\PYGZus{}data}\PYG{p}{,} \PYG{n}{kmeans}\PYG{o}{.}\PYG{n}{labels\PYGZus{}}\PYG{p}{)}

        \PYG{k}{return} \PYG{n}{inertia}\PYG{p}{,} \PYG{n}{silhouette\PYGZus{}coefficient}\PYG{p}{,} \PYG{n}{calinski\PYGZus{}harabasz}\PYG{p}{,} \PYG{n}{davies\PYGZus{}bouldin}

    \PYG{n}{scores}\PYG{p}{:} \PYG{n+nb}{list}\PYG{p}{[}\PYG{n}{Metrics}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{n}{compute\PYGZus{}scores}\PYG{p}{(}\PYG{n}{scaled\PYGZus{}data}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{p}{)} \PYG{k}{for} \PYG{n}{k} \PYG{o+ow}{in} \PYG{n}{k\PYGZus{}range}\PYG{p}{]}

    \PYG{n}{output}\PYG{p}{:} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}
        \PYG{n}{scores}\PYG{p}{,}
        \PYG{n}{index}\PYG{o}{=}\PYG{n}{k\PYGZus{}range}\PYG{p}{,}
        \PYG{n}{columns}\PYG{o}{=}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{inertia}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{silhouette\PYGZus{}coefficient}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{calinski\PYGZus{}harabasz}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{davies\PYGZus{}bouldin}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{p}{)}

    \PYG{n}{output}\PYG{o}{.}\PYG{n}{index}\PYG{o}{.}\PYG{n}{name} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{k}\PYG{l+s+s2}{\PYGZdq{}}

    \PYG{k}{return} \PYG{n}{output}


\PYG{k}{def} \PYG{n+nf}{plot\PYGZus{}all\PYGZus{}metrics}\PYG{p}{(}\PYG{n}{metrics\PYGZus{}data}\PYG{p}{:} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{k+kc}{None}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf}{plot\PYGZus{}metric}\PYG{p}{(}\PYG{n}{dataf}\PYG{p}{:} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{,} \PYG{n}{col}\PYG{p}{:} \PYG{n+nb}{str}\PYG{p}{,} \PYG{n}{\PYGZus{}ax}\PYG{p}{:} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{Axes}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plot\PYGZus{}title}\PYG{p}{:} \PYG{n+nb}{str} \PYG{o}{=} \PYG{n}{col}\PYG{o}{.}\PYG{n}{replace}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZus{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ }\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{\PYGZus{}ax}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{dataf}\PYG{p}{[}\PYG{n}{col}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{\PYGZus{}ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{plot\PYGZus{}title}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{title\PYGZus{}font}\PYG{p}{)}

    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}

    \PYG{k}{for} \PYG{n}{ax}\PYG{p}{,} \PYG{n}{metric} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{ax}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,} \PYG{n}{metrics\PYGZus{}data}\PYG{o}{.}\PYG{n}{columns}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{plot\PYGZus{}metric}\PYG{p}{(}\PYG{n}{metrics\PYGZus{}data}\PYG{p}{,} \PYG{n}{metric}\PYG{p}{,} \PYG{n}{ax}\PYG{p}{)}


\PYG{n}{selected\PYGZus{}stalls\PYGZus{}metrics} \PYG{o}{=} \PYG{n}{get\PYGZus{}kmeans\PYGZus{}metrics}\PYG{p}{(}\PYG{n}{selected\PYGZus{}stalls\PYGZus{}lonlat}\PYG{p}{,} \PYG{l+m+mi}{70}\PYG{p}{,} \PYG{l+m+mi}{42}\PYG{p}{)}

\PYG{n}{plot\PYGZus{}all\PYGZus{}metrics}\PYG{p}{(}\PYG{n}{selected\PYGZus{}stalls\PYGZus{}metrics}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{04-stations_kmeans_8_0}.png}

\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
The \(WSS\) or inertia is not really indicative of a significant value of \(K\). The silhouette coefficient is greatest for a quite small number of clusters (smaller than 5) and in general not greater than 20. This appears to be the case for the Calinski\sphinxhyphen{}Harabasz index too and, while the same cannot be said of the Davies\sphinxhyphen{}Bouldin index, beyond said threshold the index is bound to improve. Our final choice should fall on 18, as we believe that clustering the whole set of stations into three great clusters bears no practical utility for the purpose of the policymaker \sphinxhyphen{} forecasting the bikes demand in Milan.

\sphinxAtStartPar
However, as mentioned above, the total number of neighbourhoods inside our area of analysis is 25: at this point, the policymaker might just be better off aggregating the data by neighbourhood, without going through the hassle of computing the \sphinxstyleemphasis{k}\sphinxhyphen{}means. Indeed, in this context the purpose of fitting a \sphinxstyleemphasis{k}\sphinxhyphen{}means should be to isolate a small amount of clusters inside of each neighbourhood, in order to be able to aggregate together stations that are quite close to each other and that cannot all be used at once as independent variables for the forecasting models without injecting error in the estimates via multicollinearity. In this way, it would also be possible to include neighbourhood fixed effects \sphinxhyphen{} which would otherwise be impossible to add to the regression if data was aggregated ad that level.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{fit\PYGZus{}kmeans}\PYG{p}{(}\PYG{n}{input\PYGZus{}data}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{n}{rand}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n+nb}{object}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{make\PYGZus{}pipeline}\PYG{p}{(}\PYG{n}{StandardScaler}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{KMeans}\PYG{p}{(}\PYG{n}{n\PYGZus{}clusters}\PYG{o}{=}\PYG{n}{k}\PYG{p}{,} \PYG{n}{random\PYGZus{}state}\PYG{o}{=}\PYG{n}{rand}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{fit}\PYG{p}{(}\PYG{n}{input\PYGZus{}data}\PYG{p}{)}


\PYG{k}{def} \PYG{n+nf}{assign\PYGZus{}clusters}\PYG{p}{(}\PYG{n}{input\PYGZus{}data}\PYG{p}{:} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{,} \PYG{n}{fitted\PYGZus{}kmeans}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{input\PYGZus{}data}\PYG{o}{.}\PYG{n}{assign}\PYG{p}{(}\PYG{n}{cluster}\PYG{o}{=}\PYG{n}{fitted\PYGZus{}kmeans}\PYG{o}{.}\PYG{n}{labels\PYGZus{}}\PYG{p}{)}


\PYG{k}{def} \PYG{n+nf}{make\PYGZus{}geodataframe}\PYG{p}{(}
        \PYG{n}{data}\PYG{p}{:} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{,}
        \PYG{n}{cols}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,}
        \PYG{n}{crs}\PYG{p}{:} \PYG{n+nb}{int} \PYG{o}{=} \PYG{l+m+mi}{4326}
\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{geopandas}\PYG{o}{.}\PYG{n}{GeoDataFrame}\PYG{p}{:}
    \PYG{k}{if} \PYG{n}{cols} \PYG{o+ow}{is} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{cols} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{longitudine}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{latitudine}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
    \PYG{k}{return} \PYG{n}{data}\PYG{o}{.}\PYG{n}{pipe}\PYG{p}{(}
        \PYG{n}{geopandas}\PYG{o}{.}\PYG{n}{GeoDataFrame}\PYG{p}{,}
        \PYG{n}{geometry}\PYG{o}{=}\PYG{n}{geopandas}\PYG{o}{.}\PYG{n}{points\PYGZus{}from\PYGZus{}xy}\PYG{p}{(}
            \PYG{n}{data}\PYG{p}{[}\PYG{n}{cols}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{data}\PYG{p}{[}\PYG{n}{cols}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{crs}\PYG{o}{=}\PYG{n}{crs}\PYG{p}{)}
    \PYG{p}{)}


\PYG{k}{def} \PYG{n+nf}{plot\PYGZus{}clusters}\PYG{p}{(}
        \PYG{n}{geodata}\PYG{p}{:} \PYG{n}{geopandas}\PYG{o}{.}\PYG{n}{GeoDataFrame}\PYG{p}{,}
        \PYG{n}{cluster\PYGZus{}col}\PYG{p}{:} \PYG{n+nb}{str}\PYG{p}{,}
        \PYG{n}{layer}\PYG{p}{:} \PYG{n}{Union}\PYG{p}{[}\PYG{n}{geopandas}\PYG{o}{.}\PYG{n}{GeoDataFrame}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{]}
\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{k+kc}{None}\PYG{p}{:}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}

    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{off}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

    \PYG{n}{num\PYGZus{}of\PYGZus{}clusters}\PYG{p}{:} \PYG{n+nb}{int} \PYG{o}{=} \PYG{n}{geodata}\PYG{p}{[}\PYG{n}{cluster\PYGZus{}col}\PYG{p}{]}\PYG{o}{.}\PYG{n}{nunique}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Bikemi Stalls, Result of KMeans Clustering (\PYGZdl{}k\PYGZdl{} = }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num\PYGZus{}of\PYGZus{}clusters}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{title\PYGZus{}font}\PYG{p}{)}

    \PYG{k}{if} \PYG{n}{layer} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{layer}\PYG{o}{.}\PYG{n}{to\PYGZus{}crs}\PYG{p}{(}\PYG{l+m+mi}{3857}\PYG{p}{)}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{)}
    \PYG{n}{geodata}\PYG{o}{.}\PYG{n}{to\PYGZus{}crs}\PYG{p}{(}\PYG{l+m+mi}{3857}\PYG{p}{)}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{column}\PYG{o}{=}\PYG{n}{cluster\PYGZus{}col}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{)}
    \PYG{n}{cx}\PYG{o}{.}\PYG{n}{add\PYGZus{}basemap}\PYG{p}{(}\PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{)}

    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{kmeans\PYGZus{}18} \PYG{o}{=} \PYG{n}{fit\PYGZus{}kmeans}\PYG{p}{(}\PYG{n}{selected\PYGZus{}stalls\PYGZus{}lonlat}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{n}{rand}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}

\PYG{n}{selected\PYGZus{}stalls\PYGZus{}18k}\PYG{p}{:} \PYG{n}{geopandas}\PYG{o}{.}\PYG{n}{GeoDataFrame} \PYG{o}{=} \PYG{p}{(}
    \PYG{n}{selected\PYGZus{}stalls\PYGZus{}lonlat}
        \PYG{o}{.}\PYG{n}{pipe}\PYG{p}{(}\PYG{n}{assign\PYGZus{}clusters}\PYG{p}{,} \PYG{n}{fitted\PYGZus{}kmeans}\PYG{o}{=}\PYG{n}{kmeans\PYGZus{}18}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        \PYG{o}{.}\PYG{n}{pipe}\PYG{p}{(}\PYG{n}{make\PYGZus{}geodataframe}\PYG{p}{)}
\PYG{p}{)}

\PYG{n}{plot\PYGZus{}clusters}\PYG{p}{(}
    \PYG{n}{selected\PYGZus{}stalls\PYGZus{}18k}\PYG{p}{,}
    \PYG{n}{cluster\PYGZus{}col}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cluster}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{n}{layer}\PYG{o}{=}\PYG{n}{nils}\PYG{o}{.}\PYG{n}{sjoin}\PYG{p}{(}\PYG{n}{selected\PYGZus{}stalls\PYGZus{}18k}\PYG{p}{)}
\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{04-stations_kmeans_11_0}.png}

\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
If we sort the metrics matrix by the values of \sphinxcode{\sphinxupquote{sihlouette\_coefficient}}, the first number of clusters greater than 25 than we meet is 46. This, however, is only the 18th best value for \(K\) according to the \sphinxcode{\sphinxupquote{silhouette\_score}}.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}k\PYGZus{}greater\PYGZus{}than\PYGZus{}25}\PYG{p}{(}\PYG{n}{metrics\PYGZus{}data}\PYG{p}{:} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{,} \PYG{n}{metric}\PYG{p}{:} \PYG{n+nb}{str} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{silhouette\PYGZus{}coefficient}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{metrics\PYGZus{}data}\PYG{o}{.}\PYG{n}{sort\PYGZus{}values}\PYG{p}{(}\PYG{n}{metric}\PYG{p}{,} \PYG{n}{ascending}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{o}{.}\PYG{n}{assign}\PYG{p}{(}\PYG{n}{ranking}\PYG{o}{=}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{metrics\PYGZus{}data}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{k \PYGZgt{} 25}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{head}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}


\PYG{n}{get\PYGZus{}k\PYGZus{}greater\PYGZus{}than\PYGZus{}25}\PYG{p}{(}\PYG{n}{selected\PYGZus{}stalls\PYGZus{}metrics}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
     inertia  silhouette\PYGZus{}coefficient  calinski\PYGZus{}harabasz  davies\PYGZus{}bouldin  \PYGZbs{}
k                                                                         
46  7.098486                0.340648         191.620618        0.694719   

    ranking  
k            
46       18  
\end{sphinxVerbatim}

\end{sphinxuseclass}
\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{kmeans\PYGZus{}46} \PYG{o}{=} \PYG{n}{fit\PYGZus{}kmeans}\PYG{p}{(}\PYG{n}{selected\PYGZus{}stalls\PYGZus{}lonlat}\PYG{p}{,} \PYG{n}{k}\PYG{o}{=}\PYG{l+m+mi}{46}\PYG{p}{,} \PYG{n}{rand}\PYG{o}{=}\PYG{l+m+mi}{42}\PYG{p}{)}

\PYG{n}{selected\PYGZus{}stalls\PYGZus{}46k}\PYG{p}{:} \PYG{n}{geopandas}\PYG{o}{.}\PYG{n}{GeoDataFrame} \PYG{o}{=} \PYG{p}{(}
    \PYG{n}{selected\PYGZus{}stalls\PYGZus{}lonlat}
        \PYG{o}{.}\PYG{n}{pipe}\PYG{p}{(}\PYG{n}{assign\PYGZus{}clusters}\PYG{p}{,} \PYG{n}{kmeans\PYGZus{}46}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        \PYG{o}{.}\PYG{n}{pipe}\PYG{p}{(}\PYG{n}{make\PYGZus{}geodataframe}\PYG{p}{)}
\PYG{p}{)}

\PYG{n}{selected\PYGZus{}nills\PYGZus{}46k}\PYG{p}{:} \PYG{n}{geopandas}\PYG{o}{.}\PYG{n}{GeoDataFrame} \PYG{o}{=} \PYG{n}{nils}\PYG{o}{.}\PYG{n}{sjoin}\PYG{p}{(}\PYG{n}{selected\PYGZus{}stalls\PYGZus{}46k}\PYG{p}{)}

\PYG{n}{plot\PYGZus{}clusters}\PYG{p}{(}
    \PYG{n}{selected\PYGZus{}stalls\PYGZus{}46k}\PYG{p}{,}
    \PYG{n}{cluster\PYGZus{}col}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cluster}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{n}{layer}\PYG{o}{=}\PYG{n}{selected\PYGZus{}nills\PYGZus{}46k}
\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{04-stations_kmeans_14_0}.png}

\end{sphinxuseclass}
\end{sphinxuseclass}
\sphinxAtStartPar
After choosing the value for \(K\), stall data is aggregated to compute the coordinates of these new “virtual stalls” as the average of the coordinates of the stations inside the cluster. Because of how spatial joins work, one neighbourhood is not plotted, and there seems to be one cluster without left without a NIL. However, the identifier (\sphinxcode{\sphinxupquote{12}}, i.e. Maciachini \sphinxhyphen{} Maggiolina) is still correctly assigned. As the last step, these virtual clusters are assigned with a join operation to the list of selected stalls, and exported.

\begin{sphinxuseclass}{cell}
\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{plot\PYGZus{}virtual\PYGZus{}clusters}\PYG{p}{(}
        \PYG{n}{virtual\PYGZus{}clusters}\PYG{p}{:} \PYG{n}{geopandas}\PYG{o}{.}\PYG{n}{GeoDataFrame}\PYG{p}{,}
        \PYG{n}{layer}\PYG{p}{:} \PYG{n}{Union}\PYG{p}{[}\PYG{n}{geopandas}\PYG{o}{.}\PYG{n}{GeoDataFrame}\PYG{p}{,} \PYG{k+kc}{None}\PYG{p}{]}
\PYG{p}{)} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}} \PYG{k+kc}{None}\PYG{p}{:}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}

    \PYG{k}{if} \PYG{n}{layer} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{k+kc}{None}\PYG{p}{:}
        \PYG{n}{layer}\PYG{o}{.}\PYG{n}{to\PYGZus{}crs}\PYG{p}{(}\PYG{l+m+mi}{3857}\PYG{p}{)}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{summer}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{)}
    \PYG{n}{virtual\PYGZus{}clusters}\PYG{o}{.}\PYG{n}{to\PYGZus{}crs}\PYG{p}{(}\PYG{l+m+mi}{3857}\PYG{p}{)}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{)}
    \PYG{n}{cx}\PYG{o}{.}\PYG{n}{add\PYGZus{}basemap}\PYG{p}{(}\PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{)}

    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{off}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Virtual Stalls \PYGZhy{} KMeans Clustering (\PYGZdl{}k\PYGZdl{}=46)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{title\PYGZus{}font}\PYG{p}{)}

    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}


\PYG{n}{virtual\PYGZus{}stalls}\PYG{p}{:} \PYG{n}{geopandas}\PYG{o}{.}\PYG{n}{GeoDataFrame} \PYG{o}{=} \PYG{p}{(}
    \PYG{n}{selected\PYGZus{}stalls\PYGZus{}46k}
        \PYG{o}{.}\PYG{n}{groupby}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cluster}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{[}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{longitudine}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{latitudine}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}\PYG{p}{]}
        \PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{p}{)}
        \PYG{o}{.}\PYG{n}{pipe}\PYG{p}{(}\PYG{n}{make\PYGZus{}geodataframe}\PYG{p}{)}
        \PYG{o}{.}\PYG{n}{rename}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{longitudine}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lon\PYGZus{}cluster}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{latitudine}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lat\PYGZus{}cluster}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{o}{.}\PYG{n}{sjoin}\PYG{p}{(}\PYG{n}{nils}\PYG{p}{,} \PYG{n}{how}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{left}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{o}{.}\PYG{n}{rename}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{index\PYGZus{}right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{id\PYGZus{}nil}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,} \PYG{n}{axis}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{p}{)}

\PYG{n}{plot\PYGZus{}virtual\PYGZus{}clusters}\PYG{p}{(}\PYG{n}{virtual\PYGZus{}stalls}\PYG{p}{,} \PYG{n}{layer}\PYG{o}{=}\PYG{n}{selected\PYGZus{}nills\PYGZus{}46k}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{04-stations_kmeans_16_0}.png}

\end{sphinxuseclass}
\end{sphinxuseclass}






\renewcommand{\indexname}{Index}
\printindex
\end{document}